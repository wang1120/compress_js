define(["./commonFunc"],function(f){function e(e){var c=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._widget=this._viewer.cesiumWidget;this._showMenu=true;this._infoMenuId="cfglobeInfoMenuContent";this._selectpickPosition=null;this._xyz=null;this._menuList=[];this._load();this.showGlobeMenuList=false;this._defaultMenuList=[{icon:c._globe.urlConfig.MENU_HOME,name:"详细坐标",handler:c._copyLonlat},{icon:c._globe.urlConfig.MENU_I,name:"观测此处",handler:c._viewing}];this._globeMenuList=this._defaultMenuList;this._viewer.scene.postRender.addEventListener(function(){if(c._xyz){var e=Cesium.SceneTransforms.wgs84ToWindowCoordinates(c._viewer.scene,c._xyz);c._positionPopUp(e)}});this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){c.closeMenus()},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){c.closeMenus();if(c._showMenu){var t=c._viewer.scene.pick(e.position);if(Cesium.defined(t)){if(t.id){if(t.id._rightClick){var i={lon:0,lat:0,alt:0};var n=new Cesium.Cartesian2(e.position.x,e.position.y);var o=c._viewer.camera.pickEllipsoid(n,c._viewer.scene.globe.ellipsoid);if(o){var r=Cesium.Cartographic.fromCartesian(o);var s=Cesium.Math.toDegrees(r.longitude);var a=Cesium.Math.toDegrees(r.latitude);var l=r.height;i={lon:s,lat:a,alt:l}}t.id._rightClick(t.id,i)}}}else{if(c.showGlobeMenuList){var u=c._viewer.scene.mode;if(u==Cesium.SceneMode.SCENE3D){c._xyz=c._selectpickPosition=c._viewer.scene.pickPosition(e.position)}else{var t=new Cesium.Cartesian2(e.position.x,e.position.y);c._xyz=c._selectpickPosition=c._viewer.camera.pickEllipsoid(t,c._viewer.scene.globe.ellipsoid)}if(c._xyz){c.setMenus(c._globeMenuList)}}}}},Cesium.ScreenSpaceEventType.RIGHT_CLICK)}e.prototype.setType=function(e){var t=this;t._showMenu=e};e.prototype._copyLonlat=function(){var e=this;e.closeMenus();var t=Cesium.Cartographic.fromCartesian(e._selectpickPosition);var i=Cesium.Math.toDegrees(t.longitude);var n=Cesium.Math.toDegrees(t.latitude);var o=t.height;var r={lon:i,lat:n,alt:o};var s="经度："+i+"；纬度："+n;if(e._widget._showRenderLoopErrors){var a="经纬度："+i+","+n+"<br>";a+="度分秒："+f.formatDegree(i).value+","+f.formatDegree(n).value+"<br>";a+="高程："+o+"（米）";e._widget.showErrorPanel("坐标详情",a,"*视角过高时，高程数据可能存在较大误差！")}};e.prototype._viewing=function(){var e=this;e.closeMenus();var t=e._viewer.scene.mode;if(t!=Cesium.SceneMode.SCENE3D){alert("2D状态下不支持此功能！");return}var i=e._viewer.scene.globe.ellipsoid.cartesianToCartographic(e._viewer.scene.camera.position);var n=f.deg(i.longitude);var o=f.deg(i.latitude);var r=i.height;var s=Cesium.Cartographic.fromCartesian(e._selectpickPosition);var a=Cesium.Math.toDegrees(s.longitude);var l=Cesium.Math.toDegrees(s.latitude);var u=s.height;var c=f.getDistance(n,o,a,l);var d=f.getAngle(a,l,n,o);var _=f.deg(e._viewer.scene.camera.pitch);var v=0;var g=[];for(var p=0;p<720;p++){var m=f.destinationVincenty(a,l,u,d+p*.5,0,c);g[g.length]={lon:m.lon,lat:m.lat,alt:r,heading:d+p*.5+180,pitch:_}}e._globe.toolset._rotatePoint=true;e._globe.toolset._rotateByPointList(g,0)};e.prototype._load=function(){var e=this;var t=document.createElement("div");t.setAttribute("id","cfglobeInfoMenu");t.setAttribute("style","display:none;");t.oncontextmenu=function(){window.event.returnValue=false;return false};var i=document.createElement("div");i.setAttribute("id",e._infoMenuId);i.setAttribute("class","cfglobe-infomenu");t.appendChild(i);var n=document.createElement("div");n.setAttribute("class","cfglobe-infomenu-content-wrapper");i.appendChild(n);var o=document.createElement("div");o.setAttribute("class","cfglobe-infomenu-top");n.appendChild(o);var i=document.createElement("div");i.setAttribute("id","cfglobe_infomenu_content");i.setAttribute("class","cfglobe-infomenu-content");n.appendChild(i);var r=document.createElement("div");r.setAttribute("class","cfglobe-infomenu-bot");n.appendChild(r);document.getElementById(e._globeId).getElementsByTagName("div")[0].appendChild(t)};e.prototype.closeMenus=function(){var e=this;document.getElementById("cfglobeInfoMenu").style.display="none";e._xyz=null};e.prototype.setGlobeMenus=function(e,t){var i=this;i._globeMenuList=[];if(t){i._globeMenuList=i._defaultMenuList;i._globeMenuList=i._globeMenuList.concat(e)}else{i._globeMenuList=e}};e.prototype.recoveryGlobeMenus=function(){var e=this;e._globeMenuList=e._defaultMenuList};e.prototype.getGlobeMenusByName=function(e){var t=this;for(var i=t._globeMenuList.length-1;i>=0;i--){if(t._globeMenuList[i].name==e){return t._globeMenuList[i]}}return null};e.prototype.addGlobeMenus=function(e){var t=this;t._globeMenuList=t._globeMenuList.concat(e)};e.prototype.removeGlobeMenusByName=function(e){var t=this;for(var i=t._globeMenuList.length-1;i>=0;i--){if(t._globeMenuList[i].name==e){t._globeMenuList.splice(i,1)}}};e.prototype.setMenus=function(e,t){document.getElementById("cfglobeInfoMenu").style.display="block";try{var s=this;s._menuList=e;document.getElementById("cfglobe_infomenu_content").innerHTML="";if(s._menuList.length>0){for(var i=0;i<s._menuList.length;i++){(function(r){var e=document.createElement("div");e.onclick=function(){var e=Cesium.Cartographic.fromCartesian(s._xyz);var t=Cesium.Math.toDegrees(e.longitude);var i=Cesium.Math.toDegrees(e.latitude);var n=e.height;var o={lon:t,lat:i,alt:n};s._menuList[r].handler.call(s,s._menuList[r],o)};e.setAttribute("class","cfglobe-infomenu-content-div");var t=s._globe.urlConfig.MENU_I;var i=document.createElement("img");if(s._menuList[r].icon){t=s._menuList[r].icon}i.setAttribute("src",t);e.appendChild(i);var n=document.createElement("span");n.innerHTML=s._menuList[r].name;e.appendChild(n);document.getElementById("cfglobe_infomenu_content").appendChild(e)})(i)}if(t){var n=Cesium.Cartographic.fromDegrees(t.lon,t.lat,t.alt);s._xyz=s._viewer.scene.globe.ellipsoid.cartographicToCartesian(n)}var o=Cesium.SceneTransforms.wgs84ToWindowCoordinates(s._viewer.scene,s._xyz);s._positionPopUp(o)}}catch(e){if(s._widget._showRenderLoopErrors){var r="请检查菜单参数！";s._widget.showErrorPanel(r,undefined,e)}return}};e.prototype._positionPopUp=function(e,t){var i=this;if(e){var n=document.getElementById(i._infoMenuId);if(n){var o=e.x+10;var r=e.y-30;n.style.transform="translate3d("+o+"px, "+r+"px, 0)"}}};return e});