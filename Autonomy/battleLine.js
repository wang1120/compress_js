define([],function(){function e(e){var g=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._showMenu=true;this._layer={draw:false,drawid:"",layer:this._globe._defaultLayer,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",mid:"",name:"default",callback:null,rightClick:null,subset:[]};this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=g._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var t=Cesium.Cartographic.fromCartesian(g._viewer.scene.camera.position);e=t.height}else{e=Math.ceil(g._viewer.camera.positionCartographic.height)}for(var l=0;l<g._layer.subset.length;l++){if(e>=g._layer.subset[l].minHeight&&e<=g._layer.subset[l].maxHeight){g._layer.subset[l].showHeight=true}else{g._layer.subset[l].showHeight=false}if(g._layer.subset[l].showHeight&&g._layer.subset[l].showLayer&&g._layer.subset[l].showEntity){for(var r=0;r<g._layer.subset[l].polygons.length;r++){g._layer.subset[l].polygons[r].polygon.show=true}}else{for(var r=0;r<g._layer.subset[l].polygons.length;r++){g._layer.subset[l].polygons[r].polygon.show=false}}}});this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){var a=g._globe.getLonLatByPosition(e.position);if(g._layer.draw){if(a.alt<0){a.alt=0}var t=Cesium.Cartographic.fromCartesian(g._viewer.scene.camera.position);m_alt=t.height;if(true){if(g._layer.drawid==""){var l={id:"newbattleLine",layer:g._layer.layer,catalog:g._layer.catalog,subcatalog:g._layer.subcatalog,minHeight:g._layer.minHeight,maxHeight:g._layer.maxHeight,showHeight:true,showLayer:true,showEntity:true,mid:g._layer.mid,name:g._layer.name,callback:g._layer.callback,polygons:[],points:[]};g._layer.subset.push(l);g._layer.drawid="newbattleLine";var r=(new Date).getTime()+"a"+parseInt(100*Math.random());g._globe.layerManager._add("entityLayer",r,g._layer.catalog,g._layer.subcatalog)}var i;for(var n=0;n<g._layer.subset.length;n++){if(g._layer.subset[n].id==g._layer.drawid){i=g._layer.subset[n];break}}var o={lon:a.lon,lat:a.lat,alt:a.alt};i.points.push(o);if(i.points.length==1){var s={};s.vertexList=[];s.polygon=g._viewer.entities.add({rightClick:g._layer.rightClick,mid:g._layer.mid,name:g._layer.name,polygon:{hierarchy:new Cesium.CallbackProperty(function(){return s.vertexList},false),material:Cesium.Color.RED.withAlpha(1)}});i.polygons.push(s);g._layer.drawid=m_isolationBelt.id=s.polygon.id}else{var s={};s.vertexList=[];s.polygon=g._viewer.entities.add({rightClick:g._layer.rightClick,mid:g._layer.mid,name:g._layer.name,polygon:{hierarchy:new Cesium.CallbackProperty(function(){return s.vertexList},false),material:Cesium.Color.RED.withAlpha(1)}});i.polygons.push(s)}}else{if(g._layer.callback)g._layer.callback(null);g._layer.draw=false;g._layer.drawid=""}}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=g._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}var t={lon:a.lon,lat:a.lat,alt:a.alt};if(g._layer.draw){var l;for(var r=0;r<g._layer.subset.length;r++){if(g._layer.subset[r].id==g._layer.drawid){l=g._layer.subset[r];l.points.push(t);break}}g._layer.drawid="";if(l&&l.callback){l.callback(l)}}},Cesium.ScreenSpaceEventType.RIGHT_CLICK);this._handler.setInputAction(function(e){var a=g._globe.getLonLatByPosition(e.endPosition);if(g._layer.draw&&g._layer.drawid!=""){var t;for(var l=0;l<g._layer.subset.length;l++){if(g._layer.subset[l].id==g._layer.drawid){t=g._layer.subset[l];break}}if(t.points.length>0){if(a.alt<0){a.alt=0}var r={lon:a.lon,lat:a.lat,alt:a.alt};var i=[];i.push(t.points[t.points.length-1]);i.push(r);var n=g.getPointList(i);t.polygons[t.polygons.length-1].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(n)}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}e.prototype.getPointList=function(e){if(e.length<2){return[]}var a=this;var t=2e3;var l=30;var r=300;var i=[];var n=[];for(var o=1;o<e.length;o++){var s=e[o-1];var g=e[o];if(o==1){var y=[];var _=a._globe.commonFunc.getDistance(s.lon,s.lat,g.lon,g.lat);var u=a._globe.commonFunc.getAngle(s.lon,s.lat,g.lon,g.lat);m_pstar={lon:e[0].lon,lat:e[0].lat,alt:t};i[i.length]=m_pstar;var h=a._globe.commonFunc.destinationVincenty(s.lon,s.lat,t,u+90,0,l);n[n.length]=h;if(_<100){y=[]}else if(_<r*2){var c=a._globe.commonFunc.destinationVincenty(s.lon,s.lat,t,u,0,_/2);y[y.length]=c}else{var m=parseInt((_-200)/r);var v=_-r*m;var b=v/2;var d=Cesium.Cartesian3.fromDegrees(s.lon,s.lat,t);var p=Cesium.Cartesian3.fromDegrees(g.lon,g.lat,t);var f=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(p,d,f);Cesium.Cartesian3.normalize(f,f);var w=new Cesium.Ray(d,f);for(var C=0;C<=m;C++){var H=b+r*C;var L=Cesium.Ray.getPoint(w,H);var k=Cesium.Cartographic.fromCartesian(L);var x=Cesium.Math.toDegrees(k.longitude);var M=Cesium.Math.toDegrees(k.latitude);var E=k.height;var c={lon:x,lat:M,alt:E};y.push(c)}}for(var C=0;C<y.length;C++){var F,D,V,I,P,S,A;F=a._globe.commonFunc.destinationVincenty(y[C].lon,y[C].lat,t,u+180,0,10);D=a._globe.commonFunc.destinationVincenty(F.lon,F.lat,t,u-90,0,30);V=a._globe.commonFunc.destinationVincenty(D.lon,D.lat,t,u+180,0,20);I=a._globe.commonFunc.destinationVincenty(y[C].lon,y[C].lat,t,u-90,0,60);A=a._globe.commonFunc.destinationVincenty(y[C].lon,y[C].lat,t,u,0,10);S=a._globe.commonFunc.destinationVincenty(A.lon,A.lat,t,u-90,0,30);P=a._globe.commonFunc.destinationVincenty(S.lon,S.lat,t,u,0,20);i[i.length]=F;i[i.length]=D;i[i.length]=V;i[i.length]=I;i[i.length]=P;i[i.length]=S;i[i.length]=A;var T=a._globe.commonFunc.destinationVincenty(y[C].lon,y[C].lat,t,u+90,0,l);n[n.length]=T}m_pend={lon:e[1].lon,lat:e[1].lat,alt:t};i[i.length]=m_pend;var B=a._globe.commonFunc.destinationVincenty(g.lon,g.lat,t,u+90,0,l);n[n.length]=B}}var R=[];for(var o=0;o<i.length;o++){R[R.length]=i[o]}for(var o=n.length-1;o>=0;o--){R[R.length]=n[o]}var N=new Array;for(var o=0;o<R.length;o++){N.push(R[o].lon);N.push(R[o].lat);N.push(R[o].alt)}return N};e.prototype.add=function(e){var r=this;var i=e.mid?e.mid:"";var n=e.name?e.name:"default";var a=e.rightClick?e.rightClick:null;var o=e.pointList?e.pointList:[];var t=e.layer?e.layer:r._globe._defaultLayer;var l=e.catalog?e.catalog:r._catalog;var s=e.subcatalog?e.subcatalog:r._subcatalog;var g=e.minHeight?e.minHeight:r._minHeight;var y=e.maxHeight?e.maxHeight:r._maxHeight;var _={layer:t,catalog:l,subcatalog:s,minHeight:g,maxHeight:y,showHeight:true,showLayer:true,showEntity:true,mid:i,name:n,callback:null,polygons:[],points:o};for(var u=0;u<o.length-1;u++){(function(e){var a={};a.vertexList=[];var t=[];t.push(o[e]);t.push(o[e+1]);var l=r.getPointList(t);a.vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(l);a.polygon=r._viewer.entities.add({rightClick:r._layer.rightClick,mid:i,name:n,polygon:{hierarchy:new Cesium.CallbackProperty(function(){return a.vertexList},false),material:Cesium.Color.RED.withAlpha(1)}});_.polygons.push(a);if(e==0){_.id=a.polygon.id}})(u)}r._layer.subset.push(_);var h=(new Date).getTime()+"a"+parseInt(100*Math.random());r._globe.layerManager._add("entityLayer",h,l,s);return _};e.prototype.drawHandler=function(e){var a=this;var t=e.mid?e.mid:"";var l=e.name?e.name:"default";var r=e.callback?e.callback:null;var i=e.rightClick?e.rightClick:null;var n=e.layer?e.layer:a._globe._defaultLayer;var o=e.catalog?e.catalog:a._catalog;var s=e.subcatalog?e.subcatalog:a._subcatalog;var g=e.minHeight?e.minHeight:a._minHeight;var y=e.maxHeight?e.maxHeight:a._maxHeight;a._layer.draw=true;a._layer.drawid="";a._layer.mid=t;a._layer.name=l;a._layer.callback=r;a._layer.rightClick=i;a._layer.layer=n;a._layer.catalog=o;a._layer.subcatalog=s;a._layer.minHeight=g;a._layer.maxHeight=y;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.deactivateHandler=function(){var e=this;e._layer.draw=false;e._layer.drawid="";e._layer.mid="";e._layer.name="default";e._layer.callback=null;e._layer.layer=e._globe._defaultLayer;e._layer.catalog=e._catalog;e._layer.subcatalog=e._subcatalog;e._layer.minHeight=e._minHeight;e._layer.maxHeight=e._maxHeight;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;var t;for(var l=a._layer.subset.length-1;l>=0;l--){if(a._layer.subset[l].id==e.id){var r=a._layer.subset[l].catalog;var i=a._layer.subset[l].subcatalog;for(var n=a._layer.subset[l].polygons.length-1;n>=0;n--){t=a._viewer.entities.remove(a._layer.subset[l].polygons[n].polygon);if(!t){break}}if(!t){break}a._layer.subset.splice(l,1);a._globe.layerManager._remove("entityLayer",r,i)}}a._layer.draw=false;a._layer.name="default";a._layer.drawid="";a._layer.callback=null;a._layer.layer=a._globe._defaultLayer;a._layer.catalog=a._catalog;a._layer.subcatalog=a._subcatalog;a._layer.minHeight=a._minHeight;a._layer.maxHeight=a._maxHeight;return t};e.prototype.removeByMid=function(e){var a=this;var t=true;for(var l=a._layer.subset.length-1;l>=0;l--){if(a._layer.subset[l].mid==e){var r=a._layer.subset[l].catalog;var i=a._layer.subset[l].subcatalog;for(var n=a._layer.subset[l].polygons.length-1;n>=0;n--){t=a._viewer.entities.remove(a._layer.subset[l].polygons[n].polygon);if(!t){break}}if(!t){break}a._layer.subset.splice(l,1);a._globe.layerManager._remove("entityLayer",r,i)}}a._layer.draw=false;a._layer.name="default";a._layer.drawid="";a._layer.callback=null;a._layer.layer=a._globe._defaultLayer;a._layer.catalog=a._catalog;a._layer.subcatalog=a._subcatalog;a._layer.minHeight=a._minHeight;a._layer.maxHeight=a._maxHeight;return t};e.prototype.removeByName=function(e){var a=this;var t=true;for(var l=a._layer.subset.length-1;l>=0;l--){if(a._layer.subset[l].name==e){var r=a._layer.subset[l].catalog;var i=a._layer.subset[l].subcatalog;for(var n=a._layer.subset[l].polygons.length-1;n>=0;n--){t=a._viewer.entities.remove(a._layer.subset[l].polygons[n].polygon);if(!t){break}}if(!t){break}a._layer.subset.splice(l,1);a._globe.layerManager._remove("entityLayer",r,i)}}a._layer.draw=false;a._layer.name="default";a._layer.drawid="";a._layer.callback=null;a._layer.layer=a._globe._defaultLayer;a._layer.catalog=a._catalog;a._layer.subcatalog=a._subcatalog;a._layer.minHeight=a._minHeight;a._layer.maxHeight=a._maxHeight;return t};e.prototype.getByMid=function(e){var a=this;var t=[];for(var l=a._layer.subset.length-1;l>=0;l--){if(a._layer.subset[l].mid==e){t.push(a._layer.subset[l])}}return t};e.prototype.getByName=function(e){var a=this;var t=[];for(var l=a._layer.subset.length-1;l>=0;l--){if(a._layer.subset[l].name==e){t.push(a._layer.subset[l])}}return t};return e});