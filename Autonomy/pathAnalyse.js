define([],function(){function e(e){var i=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._dist=0;this._path_manager={draw:false,selectSpoint:false,spoint:null,selectTpoint:false,tpoints:[],selectEpoint:false,epoint:null};this._layer=[];this._color=Cesium.Color.GREEN;this._colorNun=0;this._colorList=[Cesium.Color.RED,Cesium.Color.ORANGE,Cesium.Color.YELLOW,Cesium.Color.GREEN,Cesium.Color.BLUE,Cesium.Color.VIOLET,Cesium.Color.LAWNGREEN,Cesium.Color.MAGENTA,Cesium.Color.MEDIUMSLATEBLUE,Cesium.Color.ORANGERED,Cesium.Color.YELLOWGREEN];this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){var t=i._globe.getLonLatByPosition(e.position);if(i._path_manager.draw){if(i._path_manager.selectSpoint){if(i._path_manager.spoint){for(var a=i._layer.length-1;a>=0;a--){i._viewer.entities.remove(i._layer[a]);i._layer.pop()}}i._path_manager.spoint=t;i._drawPoint(t,"起")}else if(i._path_manager.selectTpoint){if(i._path_manager.spoint){i._path_manager.tpoints.push(t);i._drawPoint(t,"过")}else{alert("请先选取起始点")}}else if(i._path_manager.selectEpoint){if(i._path_manager.spoint){i._path_manager.epoint=t;i._drawPoint(t,"止");i._actionAnalyse()}else{alert("请先选取起始点")}}}},Cesium.ScreenSpaceEventType.LEFT_CLICK)}e.prototype.analyseByPoints=function(e){var t=this;t._color=t._colorList[0];t._colorNun++;if(t._colorNun==t._colorList.length){t._colorNun=0}if(e&&e.length>1){for(var a=0;a<e.length;a++){var i="";if(a==0){i="起"}else if(a==e.length-1){i="止"}else{i="过"}t._drawPoint(e[a],i);if(a>0){if(a==e.length-1){t._drawPathByPoints(e[a],e[a-1],"e")}else{t._drawPathByPoints(e[a],e[a-1],"t")}}}}else{alert("点集合错误！")}};e.prototype._actionAnalyse=function(){var e=this;e._dist=0;e._color=e._colorList[e._colorNun];e._colorNun++;if(e._colorNun==e._colorList.length){e._colorNun=0}if(e._path_manager.tpoints.length>0){for(var t=0;t<e._path_manager.tpoints.length;t++){if(t==0){e._drawPathByPoints(e._path_manager.spoint,e._path_manager.tpoints[t],"t");if(e._path_manager.tpoints.length==1){e._drawPathByPoints(e._path_manager.tpoints[t],e._path_manager.epoint,"e")}}else if(t==e._path_manager.tpoints.length-1){e._drawPathByPoints(e._path_manager.tpoints[t-1],e._path_manager.tpoints[t],"t");e._drawPathByPoints(e._path_manager.tpoints[t],e._path_manager.epoint,"e")}else{e._drawPathByPoints(e._path_manager.tpoints[t-1],e._path_manager.tpoints[t],"t")}}}else{e._drawPathByPoints(e._path_manager.spoint,e._path_manager.epoint,"e")}};e.prototype.selectSpoint=function(){var e=this;e._path_manager.draw=true;e._path_manager.selectSpoint=true;e._path_manager.spoint=null;e._path_manager.selectTpoint=false;e._path_manager.tpoints=[];e._path_manager.selectEpoint=false;e._path_manager.epoint=null;for(var t=e._layer.length-1;t>=0;t--){e._viewer.entities.remove(e._layer[t]);e._layer.pop()}};e.prototype.selectTpoint=function(){var e=this;e._path_manager.draw=true;e._path_manager.selectSpoint=false;e._path_manager.selectTpoint=true;e._path_manager.tpoints=[];e._path_manager.selectEpoint=false;e._path_manager.epoint=null};e.prototype.selectEpoint=function(){var e=this;e._path_manager.draw=true;e._path_manager.selectSpoint=false;e._path_manager.selectTpoint=false;e._path_manager.selectEpoint=true;e._path_manager.epoint=null};e.prototype.selectEnd=function(){var e=this;e._path_manager.draw=false;e._path_manager.selectSpoint=false;e._path_manager.spoint=null;e._path_manager.selectTpoint=false;e._path_manager.tpoints=[];e._path_manager.selectEpoint=false;e._path_manager.epoint=null;e._color=Cesium.Color.GREEN};e.prototype._drawPoint=function(e,t){var a=this;var i=new Cesium.PinBuilder;var n=a._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(e.lon,e.lat),billboard:{image:i.fromText(t,Cesium.Color.RED,48).toDataURL(),width:30,height:30,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND,disableDepthTestDistance:Number.POSITIVE_INFINITY}});a._layer.push(n)};e.prototype._drawPathByPoints=function(e,t,c){var f=this;var C=e;var v=t;var d=5;$.ajax(f._globe.urlConfig.LOCALOWS,{type:"GET",data:{service:"WFS",version:"1.0.0",request:"GetFeature",typename:"cf:roadnet",outputFormat:"application/json",viewparams:"x1:"+C.lon+";y1:"+C.lat+";x2:"+v.lon+";y2:"+v.lat},success:function(e){if(!e.features){return}var t=e.features[0].geometry.coordinates;var g=0;if(t.length==2&&t[0][0]==t[1][0]&&t[0][1]==t[1][1]){g=CommonFunc.getDistance(C.lon,C.lat,v.lon,v.lat);var a=new Array;a.push(C.lon);a.push(C.lat);a.push(C.alt);a.push(v.lon);a.push(v.lat);a.push(v.alt);var i=Cesium.Cartesian3.fromDegreesArrayHeights(a);var n=f._viewer.entities.add({polyline:{positions:i,width:5,material:new Cesium.PolylineDashMaterialProperty({color:Cesium.Color.ORANGE,dashLength:8})}});f._layer.push(n);if(c=="t"){f._dist+=g}else if(c=="e"){f._dist+=g;var r=f._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(C.lon,C.lat),label:{text:(f._dist/1e3).toFixed(2)+"km",font:"14pt sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.LEFT,pixelOffset:new Cesium.Cartesian2(15,0),verticalOrigin:Cesium.VerticalOrigin.BASELINE,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND,disableDepthTestDistance:Number.POSITIVE_INFINITY}});f._layer.push(r);f._dist=0}return}var o=[];for(var s=0;s<t.length;s++){var l=t[s][0];var p=t[s][1];var _={lon:l,lat:p,alt:2e3};o[o.length]=_;if(s>0){var h=CommonFunc.getDistance(t[s][0],t[s][1],t[s-1][0],t[s-1][1]);g+=h}}f._globe.getAltByLonlat(o,function(e){var t=new Array;for(var a=0;a<e.length;a++){t.push(e[a].lon);t.push(e[a].lat);t.push(e[a].alt+d)}var i=Cesium.Cartesian3.fromDegreesArrayHeights(t);var n=f._viewer.entities.add({polyline:{positions:i,width:5,material:f._color.withAlpha(1)}});f._layer.push(n);var r=CommonFunc.getDistance(C.lon,C.lat,e[0].lon,e[0].lat);g+=r;var o=CommonFunc.getDistance(C.lon,C.lat,e[e.length-1].lon,e[e.length-1].lat);g+=o;var s=new Array;if(r<o){s.push(e[0].lon);s.push(e[0].lat);s.push(e[0].alt+d)}else{s.push(e[e.length-1].lon);s.push(e[e.length-1].lat);s.push(e[e.length-1].alt+d)}s.push(C.lon);s.push(C.lat);s.push(C.alt);var l=Cesium.Cartesian3.fromDegreesArrayHeights(s);var p=f._viewer.entities.add({polyline:{positions:l,width:5,material:new Cesium.PolylineDashMaterialProperty({color:Cesium.Color.ORANGE,dashLength:8})}});f._layer.push(p);var _=new Array;if(r<o){_.push(e[e.length-1].lon);_.push(e[e.length-1].lat);_.push(e[e.length-1].alt+d)}else{_.push(e[0].lon);_.push(e[0].lat);_.push(e[0].alt+d)}_.push(v.lon);_.push(v.lat);_.push(v.alt);var h=Cesium.Cartesian3.fromDegreesArrayHeights(_);var u=f._viewer.entities.add({polyline:{positions:h,width:5,material:new Cesium.PolylineDashMaterialProperty({color:Cesium.Color.ORANGE,dashLength:8})}});f._layer.push(u);if(c=="t"){f._dist+=g}else if(c=="e"){f._dist+=g;var m=f._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(C.lon,C.lat),label:{text:(f._dist/1e3).toFixed(2)+"km",font:"14pt sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.LEFT,pixelOffset:new Cesium.Cartesian2(15,0),verticalOrigin:Cesium.VerticalOrigin.BASELINE,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND,disableDepthTestDistance:Number.POSITIVE_INFINITY}});f._layer.push(m);f._dist=0}})}})};e.prototype.clear=function(){var e=this;e.selectEnd();for(var t=e._layer.length-1;t>=0;t--){e._viewer.entities.remove(e._layer[t]);e._layer.pop()}};return e});