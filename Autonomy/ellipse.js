define([],function(){function e(e){var w=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._layer=[];this._showMenu=true;this._options={draw:false,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",drawid:"",handlerCallback:null,options:null};this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=w._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var t=Cesium.Cartographic.fromCartesian(w._viewer.scene.camera.position);e=t.height}else{e=Math.ceil(w._viewer.camera.positionCartographic.height)}for(var i=0;i<w._layer.length;i++){if(e>=w._layer[i].minHeight&&e<=w._layer[i].maxHeight){w._layer[i].showHeight=true}else{w._layer[i].showHeight=false}if(w._layer[i].showHeight&&w._layer[i].showLayer&&w._layer[i].showEntity){w._layer[i].ellipse.show=true}else{w._layer[i].ellipse.show=false}}});this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.position);if(w._options.draw&&w._options.drawid==""){var t={};for(var i in w._options.options){if(i!="color"&&i!="layer"){t[i]=typeof w._options.options[i]==="object"?deepCoyp(w._options.options[i]):w._options.options[i]}}var r=t.mid?t.mid:"";var o=t.name?t.name:"";var l=t.width?t.width:3;var n=t.wlpha?t.wlpha:.5;var s=t.rightClick?t.rightClick:null;var h=t.catalog?t.catalog:w._catalog;var p=t.subcatalog?t.subcatalog:w._subcatalog;var _=t.minHeight?t.minHeight:w._minHeight;var g=t.maxHeight?t.maxHeight:w._maxHeight;var y=w._options.options.color?w._options.options.color:Cesium.Color.BLUE;var m=w._options.options.layer?w._options.options.layer:w._globe._defaultLayer;var v=w._options.options.clampMode?w._options.options.clampMode:0;var u=[a];var c={ellipse:null,pointList:u,semiMinorAxis:0,semiMajorAxis:0,rotation:0,catalog:h,subcatalog:p,minHeight:_,maxHeight:g,showHeight:true,showLayer:true,showEntity:true,layer:m};if(v==0){c.ellipse=w._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(a.lon,a.lat),mid:r,name:o,rightClick:s,ellipse:{semiMinorAxis:new Cesium.CallbackProperty(function(){return c.semiMinorAxis},false),semiMajorAxis:new Cesium.CallbackProperty(function(){return c.semiMajorAxis},false),rotation:new Cesium.CallbackProperty(function(){return c.rotation},false),height:2e3,material:y.withAlpha(n)}})}else{c.ellipse=w._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(a.lon,a.lat),mid:r,name:o,rightClick:s,ellipse:{semiMinorAxis:new Cesium.CallbackProperty(function(){return c.semiMinorAxis},false),semiMajorAxis:new Cesium.CallbackProperty(function(){return c.semiMajorAxis},false),rotation:new Cesium.CallbackProperty(function(){return c.rotation},false),material:y.withAlpha(n)}})}w._layer.push(c);w._options.drawid=c.ellipse.id;var d=(new Date).getTime()+"a"+parseInt(100*Math.random());w._globe.layerManager._add("entityLayer",d,h,p)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.endPosition);if(w._options.draw&&w._options.drawid!=""){var t=w._layer[w._layer.length-1].pointList.slice(0);var i=Cesium.Cartesian3.fromDegrees(t[t.length-1].lon,t[t.length-1].lat);var r=Cesium.Cartesian3.fromDegrees(a.lon,a.lat);var o=Cesium.Cartesian3.distance(i,r);var l=Math.abs(a.lon-t[t.length-1].lon);var n=Math.abs(a.lat-t[t.length-1].lat);var s=o;var h;if(Math.pow(s,2)-Math.pow(r.x-i.x,2)!=0){h=Math.sqrt(Math.abs(Math.pow(s,2)*Math.pow(r.y-i.y,2)/(Math.pow(s,2)-Math.pow(r.x-i.x,2))));w._layer[w._layer.length-1].rotation=l>n?Cesium.Math.toRadians(0):Cesium.Math.toRadians(90);w._layer[w._layer.length-1].semiMajorAxis=s;w._layer[w._layer.length-1].semiMinorAxis=h}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}if(w._options.draw&&w._options.drawid!=""){var t=w._layer[w._layer.length-1].pointList.slice(0);if(!(t[t.length-1].lon==a.lon&&t[t.length-1].lat==a.lat)){w._layer[w._layer.length-1].pointList.push(a)}var i=w._layer[w._layer.length-1].pointList.slice(0);if(i.length>1){var r=Cesium.Cartesian3.fromDegrees(i[i.length-2].lon,i[i.length-2].lat);var o=Cesium.Cartesian3.fromDegrees(i[i.length-1].lon,i[i.length-1].lat);var l=Cesium.Cartesian3.distance(r,o);var n=Math.abs(a.lon-i[i.length-1].lon);var s=Math.abs(a.lat-i[i.length-1].lat);var h=l;var p;if(Math.pow(h,2)-Math.pow(o.x-r.x,2)!=0){p=Math.sqrt(Math.abs(Math.pow(h,2)*Math.pow(o.y-r.y,2)/(Math.pow(h,2)-Math.pow(o.x-r.x,2))));w._layer[w._layer.length-1].semiMajorAxis=h;w._layer[w._layer.length-1].semiMinorAxis=p}w._options.drawid="";if(w._options.handlerCallback)w._options.handlerCallback(w._layer[w._layer.length-1])}}},Cesium.ScreenSpaceEventType.RIGHT_CLICK)}e.prototype.drawHandler=function(e){var a=this;a._options.draw=true;a._options.drawid="";a._options.options=e;var t=e.handlerCallback?e.handlerCallback:null;a._options.handlerCallback=t;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.add=function(e){var a=this;var t=e.mid?e.mid:"";var i=e.name?e.name:"";var r=e.width?parseInt(e.width):3;var o=e.wlpha?parseFloat(e.wlpha):1;var l=e.rightClick?e.rightClick:null;var n=e.color?e.color:Cesium.Color.BLUE;var s=e.pointList?e.pointList:[];var h=e.layer?e.layer:a._globe._defaultLayer;var p=e.catalog?e.catalog:a._catalog;var _=e.subcatalog?e.subcatalog:a._subcatalog;var g=e.minHeight?e.minHeight:a._minHeight;var y=e.maxHeight?e.maxHeight:a._maxHeight;var m=Cesium.Cartesian3.fromDegrees(s[0].lon,s[0].lat);var v=Cesium.Cartesian3.fromDegrees(s[1].lon,s[1].lat);var u=Cesium.Cartesian3.distance(m,v);var c=u;var d;if(Math.pow(c,2)-Math.pow(v.x-m.x,2)!=0){d=Math.sqrt(Math.abs(Math.pow(c,2)*Math.pow(v.y-m.y,2)/(Math.pow(c,2)-Math.pow(v.x-m.x,2))))}var w={ellipse:null,pointList:s,semiMinorAxis:0,semiMajorAxis:0,rotation:0,catalog:p,subcatalog:_,minHeight:g,maxHeight:y,showHeight:true,showLayer:true,showEntity:true,layer:h};w.ellipse=a._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(s[0].lon,s[0].lat),name:i,mid:t,rightClick:l,ellipse:{semiMinorAxis:d,semiMajorAxis:c,material:n.withAlpha(o)}});a._layer.push(w);var f=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",f,p,_);return w};e.prototype.deactivateHandler=function(){var e=this;e._options.draw=false;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].ellipse==e){var i=a._layer[t].catalog;var r=a._layer[t].subcatalog;var o=a._viewer.entities.remove(e);a._globe.layerManager._remove("entityLayer",i,r);a._layer.splice(t,1);return o}}};e.prototype.removeByMid=function(e){var a=this;var t=true;for(var i=a._layer.length-1;i>=0;i--){if(a._layer[i].ellipse.mid==e){var r=a._layer[i].catalog;var o=a._layer[i].subcatalog;t=a._viewer.entities.remove(a._layer[i].ellipse);a._globe.layerManager._remove("entityLayer",r,o);a._layer.splice(i,1);if(!t){return t}}}return t};e.prototype.removeByName=function(e){var a=this;var t=true;for(var i=a._layer.length-1;i>=0;i--){if(a._layer[i].ellipse.name==e){var r=a._layer[i].catalog;var o=a._layer[i].subcatalog;t=a._viewer.entities.remove(a._layer[i].ellipse);a._globe.layerManager._remove("entityLayer",r,o);a._layer.splice(i,1);if(!t){return t}}}return t};e.prototype.getByMid=function(e){var a=this;var t=[];for(var i=a._layer.length-1;i>=0;i--){if(a._layer[i].ellipse.mid==e){t[t.length]=a._layer[i].ellipse}}return t};e.prototype.getByName=function(e){var a=this;var t=[];for(var i=a._layer.length-1;i>=0;i--){if(a._layer[i].ellipse.name==e){t[t.length]=a._layer[i].ellipse}}return t};return e});