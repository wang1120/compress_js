define([],function(){function e(e){var w=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._layer=[];this._showMenu=true;this._stkLevel=14;this._options={draw:false,drawid:"",handlerCallback:null,options:null};this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=w._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var t=Cesium.Cartographic.fromCartesian(w._viewer.scene.camera.position);e=t.height}else{e=Math.ceil(w._viewer.camera.positionCartographic.height)}for(var r=0;r<w._layer.length;r++){if(e>=w._layer[r].minHeight&&e<=w._layer[r].maxHeight){w._layer[r].showHeight=true}else{w._layer[r].showHeight=false}if(w._layer[r].showHeight&&w._layer[r].showLayer&&w._layer[r].showEntity){w._layer[r].rotate.show=true}else{w._layer[r].rotate.show=false}}});this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.position);if(w._options.draw&&w._options.drawid==""){var t={};for(var r in w._options.options){if(r!="color"&&r!="layer"){t[r]=typeof w._options.options[r]==="object"?deepCoyp(w._options.options[r]):w._options.options[r]}}var n=t.mid?t.mid:"";var o=t.name?t.name:"";var l=t.width?t.width:3;var i=t.wlpha?t.wlpha:.5;var s=t.rightClick?t.rightClick:null;var v=t.catalog?t.catalog:w._catalog;var g=t.subcatalog?t.subcatalog:w._subcatalog;var c=t.minHeight?t.minHeight:w._minHeight;var m=t.maxHeight?t.maxHeight:w._maxHeight;var u=w._options.options.color?w._options.options.color:Cesium.Color.BLUE;var h=w._options.options.layer?w._options.options.layer:w._globe._defaultLayer;var _=w._options.options.clampMode?w._options.options.clampMode:0;var y=[a];var p=new Cesium.PinBuilder;var d=t.url?t.url:p.fromColor(Cesium.Color.ROYALBLUE,48).toDataURL();var C={rotate:null,pointList:y,vertexList:null,layer:h,catalog:v,subcatalog:g,minHeight:c,maxHeight:m,showHeight:true,showLayer:true,showEntity:true,angle:0};C.rotate=w._viewer.entities.add({mid:n,name:o,rightClick:s,options:t,rectangle:{coordinates:new Cesium.CallbackProperty(function(){return C.vertexList},false),material:d,rotation:new Cesium.CallbackProperty(function(){return C.angle},false),stRotation:new Cesium.CallbackProperty(function(){return C.angle},false),height:a.alt+1e3}});C.rotate.rectangle.material=new Cesium.ImageMaterialProperty({image:d,transparent:true});w._layer.push(C);w._options.drawid=C.rotate.id;var f=(new Date).getTime()+"a"+parseInt(100*Math.random());w._globe.layerManager._add("entityLayer",f,v,g)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.endPosition);if(w._options.draw&&w._options.drawid!=""){var t=w._layer[w._layer.length-1].pointList.slice(0);if(!w._contains(t,a)){t.push(a);var r=t[0];var n=t[t.length-1];var o=CommonFunc.getDistance(r.lon,r.lat,n.lon,n.lat);var l=CommonFunc.getAngle(r.lon,r.lat,n.lon,n.lat);var i=CommonFunc.destinationVincenty(r.lon,r.lat,r.alt,l,0,o/2);var s=[];var v=[];s[0]=CommonFunc.destinationVincenty(i.lon,i.lat,i.alt,270,0,o/2);s[1]=CommonFunc.destinationVincenty(i.lon,i.lat,i.alt,90,0,o/2);v[0]=CommonFunc.destinationVincenty(s[0].lon,s[0].lat,2e3,180,0,o/3);v[1]=CommonFunc.destinationVincenty(s[1].lon,s[1].lat,2e3,-90,0,o/3);var g=new Array;for(var c=0;c<v.length;c++){g.push(v[c].lon);g.push(v[c].lat)}var m=parseFloat(g[0]);var u=parseFloat(g[1]);var h=parseFloat(g[2]);var _=parseFloat(g[3]);var y=CommonFunc.getAngle(t[0].lon,t[0].lat,t[1].lon,t[1].lat);var p=y;if(y>0&&y<=90){p=90-p}else{p=450-p}y=p;var d=Cesium.Math.toRadians(y);w._layer[w._layer.length-1].vertexList=Cesium.Rectangle.fromDegrees(m,u,h,_);w._layer[w._layer.length-1].angle=d}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}if(w._options.draw&&w._options.drawid!=""){w._layer[w._layer.length-1].pointList.push(a);var t=w._layer[w._layer.length-1].pointList.slice(0);var r=w._layer[w._layer.length-1].rotate.options;var n=r.clampMode?r.clampMode:0;var o=t[0];var l=t[t.length-1];var i=CommonFunc.getDistance(o.lon,o.lat,l.lon,l.lat);var s=CommonFunc.getAngle(o.lon,o.lat,l.lon,l.lat);var v=CommonFunc.destinationVincenty(o.lon,o.lat,o.alt,s,0,i/2);var g=[];var c=[];g[0]=CommonFunc.destinationVincenty(v.lon,v.lat,v.alt,270,0,i/2);g[1]=CommonFunc.destinationVincenty(v.lon,v.lat,v.alt,90,0,i/2);c[0]=CommonFunc.destinationVincenty(g[0].lon,g[0].lat,2e3,180,0,i/3);c[1]=CommonFunc.destinationVincenty(g[1].lon,g[1].lat,2e3,-90,0,i/3);var m=new Array;for(var u=0;u<c.length;u++){m.push(c[u].lon);m.push(c[u].lat)}var h=parseFloat(m[0]);var _=parseFloat(m[1]);var y=parseFloat(m[2]);var p=parseFloat(m[3]);var d=CommonFunc.getAngle(t[0].lon,t[0].lat,t[1].lon,t[1].lat);var C=d;if(d>0&&d<=90){C=90-C}else{C=450-C}d=C;var f=Cesium.Math.toRadians(d);w._layer[w._layer.length-1].vertexList=Cesium.Rectangle.fromDegrees(h,_,y,p);w._layer[w._layer.length-1].angle=f;w._options.drawid="";w._options.handlerCallback(w._layer[w._layer.length-1])}},Cesium.ScreenSpaceEventType.RIGHT_CLICK)}e.prototype.drawHandler=function(e){var a=this;a._options.draw=true;a._options.drawid="";a._options.options=e;var t=e.handlerCallback?e.handlerCallback:null;a._options.handlerCallback=t;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.add=function(e){var a=this;var t=e.mid?e.mid:"";var r=e.name?e.name:"";var n=e.width?e.width:3;var o=e.wlpha?e.wlpha:.5;var l=e.rightClick?e.rightClick:null;var i=e.color?e.color:Cesium.Color.BLUE;var s=e.layer?e.layer:a._globe._defaultLayer;var v=e.catalog?e.catalog:a._catalog;var g=e.subcatalog?e.subcatalog:a._subcatalog;var c=e.minHeight?e.minHeight:a._minHeight;var m=e.maxHeight?e.maxHeight:a._maxHeight;var u=e.clampMode?e.clampMode:0;var h=e.pointList?e.pointList:[];var _=new Cesium.PinBuilder;var y=e.url?e.url:_.fromColor(Cesium.Color.ROYALBLUE,48).toDataURL();var p=h[0];var d=h[h.length-1];var C=CommonFunc.getDistance(p.lon,p.lat,d.lon,d.lat);var f=CommonFunc.getAngle(p.lon,p.lat,d.lon,d.lat);var w=CommonFunc.destinationVincenty(p.lon,p.lat,p.alt,f,0,C/2);var L=[];var b=[];L[0]=CommonFunc.destinationVincenty(w.lon,w.lat,w.alt,270,0,C/2);L[1]=CommonFunc.destinationVincenty(w.lon,w.lat,w.alt,90,0,C/2);b[0]=CommonFunc.destinationVincenty(L[0].lon,L[0].lat,2e3,180,0,C/3);b[1]=CommonFunc.destinationVincenty(L[1].lon,L[1].lat,2e3,-90,0,C/3);var F=new Array;for(var M=0;M<b.length;M++){F.push(b[M].lon);F.push(b[M].lat)}var H=parseFloat(F[0]);var E=parseFloat(F[1]);var V=parseFloat(F[2]);var k=parseFloat(F[3]);var x=CommonFunc.getAngle(h[0].lon,h[0].lat,h[1].lon,h[1].lat);var A=x;if(x>0&&x<=90){A=90-A}else{A=450-A}x=A;var R=Cesium.Math.toRadians(x);var B={rotate:null,pointList:h,vertexList:null,layer:s,catalog:v,subcatalog:g,minHeight:c,maxHeight:m,showHeight:true,showLayer:true,showEntity:true,angle:0};B.rotate=a._viewer.entities.add({mid:t,name:r,rightClick:l,options:e,rectangle:{coordinates:Cesium.Rectangle.fromDegrees(H,E,V,k),material:y,rotation:R,stRotation:R,height:2e3}});B.rotate.rectangle.material=new Cesium.ImageMaterialProperty({image:y,transparent:true});a._layer[a._layer.length]=B;var I=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",I,v,g);return B};e.prototype.deactivateHandler=function(){var e=this;e._options.draw=false;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].rotate==e){var r=a._layer[t].catalog;var n=a._layer[t].subcatalog;var o=a._viewer.entities.remove(e);a._layer.splice(t,1);a._globe.layerManager._remove("entityLayer",r,n);return o}}};e.prototype.removeByMid=function(e){var a=this;var t=true;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].rotate.mid==e){var n=a._layer[r].catalog;var o=a._layer[r].subcatalog;t=a._viewer.entities.remove(a._layer[r].rotate);a._layer.splice(r,1);a._globe.layerManager._remove("entityLayer",n,o);if(!t){return t}}}return t};e.prototype.removeByName=function(e){var a=this;var t=true;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].rotate.name==e){var n=a._layer[r].catalog;var o=a._layer[r].subcatalog;t=a._viewer.entities.remove(a._layer[r].rotate);a._layer.splice(r,1);a._globe.layerManager._remove("entityLayer",n,o);if(!t){return t}}}return t};e.prototype.getByMid=function(e){var a=this;var t=[];for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].rotate.mid==e){t[t.length]=a._layer[r].rotate}}return t};e.prototype.getByName=function(e){var a=this;var t=[];for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].rotate.name==e){t[t.length]=a._layer[r].rotate}}return t};e.prototype._contains=function(e,a){var t=e.length;while(t--){if(e[t].lon===a.lon&&e[t].lat===a.lat){return true}}return false};return e});