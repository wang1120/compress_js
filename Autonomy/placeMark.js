define([],function(){function e(e){var o=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=2e6;this._catalog="default";this._subcatalog="default";this._layer=[];this._layer_dataSource=[];this._selectMark;this._selectMarkShow=false;this._options={draw:false,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",handlerCallback:null,options:null};this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=o._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var r=Cesium.Cartographic.fromCartesian(o._viewer.scene.camera.position);e=r.height}else{e=Math.ceil(o._viewer.camera.positionCartographic.height)}for(var l=0;l<o._layer.length;l++){if(e>=o._layer[l].minHeight&&e<=o._layer[l].maxHeight){o._layer[l].showHeight=true}else{o._layer[l].showHeight=false}if(o._layer[l].showHeight&&o._layer[l].showLayer&&o._layer[l].showEntity){o._layer[l].show=true}else{o._layer[l].show=false}}for(var l=0;l<o._layer_dataSource.length;l++){if(e>=o._layer_dataSource[l].minHeight&&e<=o._layer_dataSource[l].maxHeight){o._layer_dataSource[l].showHeight=true}else{o._layer_dataSource[l].showHeight=false}if(o._layer_dataSource[l].showHeight&&o._layer_dataSource[l].showLayer&&o._layer_dataSource[l].showEntity){o._layer_dataSource[l].show=true}else{o._layer_dataSource[l].show=false}}});this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){var a=o._globe.getLonLatByPosition(e.position);if(o._options.draw){var r={};for(var l in o._options.options){if(l!="color"&&l!="layer"){r[l]=typeof o._options.options[l]==="object"?deepCoyp(o._options.options[l]):o._options.options[l]}}r.lon=a.lon;r.lat=a.lat;r.alt=a.alt;r.layer=o._options.options.layer?o._options.options.layer:null;var i=o.add(r);if(o._options.handlerCallback){o._options.handlerCallback(i)}}else{var t=o._viewer.scene.pick(e.position);if(Cesium.defined(t)){if(t.id){if(t.id._leftClick){t.id._leftClick(t.id)}}}}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=o._globe._viewer.scene.pick(e.endPosition);if(Cesium.defined(a)){if(a.id&&a.id.constructor!=Array){if(a.id.mousemoveShowLabel){if(o._selectMark){o._selectMark._label._show._value=o._selectMarkShow}o._selectMark=a.id;o._selectMarkShow=o._selectMark._label._show._value;a.id._label._show._value=true;var r=a.id._label._text}}}else if(o._selectMark){o._selectMark._label._show._value=o._selectMarkShow;o._selectMark=null}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this._dataSource=new Cesium.CustomDataSource("myData");this._pixelRange=15;this._minimumClusterSize=3;this._dataSource.clustering.enabled=true;this._dataSource.clustering.pixelRange=this._pixelRange;this._dataSource.clustering.minimumClusterSize=this._minimumClusterSize;var a=new Cesium.PinBuilder;var r=a.fromText("50+",Cesium.Color.fromCssColorString("#f30707"),48).toDataURL();var l=a.fromText("40+",Cesium.Color.fromCssColorString("#f93737"),48).toDataURL();var i=a.fromText("30+",Cesium.Color.fromCssColorString("#ec5834"),48).toDataURL();var t=a.fromText("20+",Cesium.Color.fromCssColorString("#ff7d5d"),48).toDataURL();var s=a.fromText("10+",Cesium.Color.fromCssColorString("#fda38d"),48).toDataURL();var n=new Array(8);for(var _=0;_<n.length;++_){n[_]=a.fromText(""+(_+2),Cesium.Color.fromCssColorString("#f1dfc7"),48).toDataURL()}var u=this._dataSource.clustering.clusterEvent.addEventListener(function(e,a){a.label.show=false;a.billboard.show=true;a.billboard.id=a.label.id;a.billboard.verticalOrigin=Cesium.VerticalOrigin.BOTTOM;a.billboard.heightReference=Cesium.HeightReference.RELATIVE_TO_GROUND;a.billboard.disableDepthTestDistance=Number.POSITIVE_INFINITY;if(e.length>=50){a.billboard.image=r}else if(e.length>=40){a.billboard.image=l}else if(e.length>=30){a.billboard.image=i}else if(e.length>=20){a.billboard.image=t}else if(e.length>=10){a.billboard.image=s}else{a.billboard.image=n[e.length-2];a.billboard.width=40;a.billboard.height=40}});this._viewer.dataSources.add(this._dataSource)}e.prototype.setDataSources=function(e){var a=this;var r=e.pixelRange?e.pixelRange:15;var l=e.minimumClusterSize?e.minimumClusterSize:3;a._dataSource.clustering.enabled=true;a._dataSource.clustering.pixelRange=r;a._dataSource.clustering.minimumClusterSize=l};e.prototype.addToDataSources=function(e){var a=this;var r=new Cesium.PinBuilder;var l=e.mid?e.mid:"";var i=e.name?e.name:"default";var t=e.width?parseInt(e.width):30;var o=e.height?parseInt(e.height):30;var s=e.lon?parseFloat(e.lon):0;var n=e.lat?parseFloat(e.lat):0;var _=e.alt?parseFloat(e.alt):0;var u=e.color?e.color:Cesium.Color.YELLOW;var h=e.url?e.url:r.fromColor(u,48).toDataURL();var v=e.callback?e.callback:null;var c=e.setMenu?e.setMenu:null;var d=e.leftClick?e.leftClick:null;var g=e.rightClick?e.rightClick:null;var m=e.description?e.description:"";var f=e.showBox!==false;var b=e.windowWidth?parseInt(e.windowWidth):100;var C=e.windowHeight?parseInt(e.windowHeight):80;var y=e.src?e.src:"";var w=e.showWindow!==false;var p=e.catalog?e.catalog:a._catalog;var S=e.subcatalog?e.subcatalog:a._subcatalog;var I=e.minHeight?e.minHeight:a._minHeight;var k=e.maxHeight?e.maxHeight:a._maxHeight;var O=e.label?e.label:"";var E=e.labelSize?e.labelSize:14;var D=e.labelFamily?e.labelFamily:"sans-serif";var H=e.mousemoveShowLabel!==false;var L;if(e.labelColor){if(e.labelColor.indexOf("#")!=-1){L=Cesium.Color.fromCssColorString(e.labelColor)}else{L=e.labelColor}}else{L=Cesium.Color.WHITE}var T=e.labelShow!==false;var F;var M;var N=e.clampMode?e.clampMode:0;if(N==0){F=Cesium.HeightReference.RELATIVE_TO_GROUND;M=Cesium.Cartesian3.fromDegrees(s,n)}else{F=Cesium.HeightReference.NONE;M=Cesium.Cartesian3.fromDegrees(s,n,_)}var x={lon:s,lat:n,alt:_};var R=a._dataSource.entities.add({mid:l,name:i,showBox:f,showWindow:w,windowWidth:b,windowHeight:C,src:y,callback:v,setMenu:c,leftClick:d,rightClick:g,position:M,description:m,markPoint:x,options:e,mousemoveShowLabel:H,catalog:p,subcatalog:S,minHeight:I,maxHeight:k,showHeight:true,showLayer:true,showEntity:true,billboard:{image:h,show:true,width:t,height:o,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:F,disableDepthTestDistance:Number.POSITIVE_INFINITY},label:{text:O.toString(),font:E+"pt "+D,fillColor:L,show:false,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,pixelOffset:new Cesium.Cartesian2(t/2,0),verticalOrigin:Cesium.VerticalOrigin.BASELINE,heightReference:F,disableDepthTestDistance:Number.POSITIVE_INFINITY}});a._layer_dataSource.push(R);var B=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",B,p,S);return R};e.prototype.add=function(e){var a=this;var r=new Cesium.PinBuilder;var l=e.mid?e.mid:"";var i=e.name?e.name:"default";var t=e.width?parseInt(e.width):30;var o=e.height?parseInt(e.height):30;var s=e.lon?parseFloat(e.lon):0;var n=e.lat?parseFloat(e.lat):0;var _=e.alt?parseFloat(e.alt):0;var u=e.color?e.color:Cesium.Color.YELLOW;var h=e.horizontalOrigin?e.horizontalOrigin:Cesium.HorizontalOrigin.CENTER;var v=e.verticalOrigin?e.verticalOrigin:Cesium.VerticalOrigin.CENTER;var c=e.url?e.url:r.fromColor(u,48).toDataURL();var d=e.callback?e.callback:null;var g=e.setMenu?e.setMenu:null;var m=e.leftClick?e.leftClick:null;var f=e.rightClick?e.rightClick:null;var b=e.description?e.description:"";var C=e.showBox!==false;var y=e.windowWidth?parseInt(e.windowWidth):100;var w=e.windowHeight?parseInt(e.windowHeight):80;var p=e.src?e.src:"";var S=e.showWindow!==false;var I=e.catalog?e.catalog:a._catalog;var k=e.subcatalog?e.subcatalog:a._subcatalog;var O=e.minHeight?e.minHeight:a._minHeight;var E=e.maxHeight?e.maxHeight:a._maxHeight;var D=e.label?e.label:"";var H=e.labelSize?e.labelSize:14;var L=e.labelFamily?e.labelFamily:"sans-serif";var T=e.mousemoveShowLabel!==false;var F=e.nearFarScalarImage?e.nearFarScalarImage:null;var M=e.nearFarScalarLabel?e.nearFarScalarLabel:null;var N=new Cesium.NearFarScalar(150,1,15e5,1);var x=new Cesium.NearFarScalar(150,1,15e5,1);if(F&&F.length==4){N=new Cesium.NearFarScalar(F[0],F[1],F[2],F[3])}if(M&&M.length==4){x=new Cesium.NearFarScalar(M[0],M[1],M[2],M[3])}var R;if(e.labelColor){if(e.labelColor.indexOf("#")!=-1){R=Cesium.Color.fromCssColorString(e.labelColor)}else{R=e.labelColor}}else{R=Cesium.Color.WHITE}var B=e.labelShow!==false;var z=false;if(e.showBackground){z=e.showBackground}var P;if(e.backgroundColor){if(e.backgroundColor.indexOf("#")!=-1){P=Cesium.Color.fromCssColorString(e.backgroundColor)}else{P=e.backgroundColor}}else{P=Cesium.Color.BLUE}var V;var U;var W=e.clampMode?e.clampMode:0;if(W==0){V=Cesium.HeightReference.RELATIVE_TO_GROUND;U=Cesium.Cartesian3.fromDegrees(s,n)}else{V=Cesium.HeightReference.NONE;U=Cesium.Cartesian3.fromDegrees(s,n,_)}var A={lon:s,lat:n,alt:_};var Y=a._viewer.entities.add({mid:l,name:i,catalog:I,subcatalog:k,showBox:C,showWindow:S,windowWidth:y,windowHeight:w,src:p,callback:d,setMenu:g,leftClick:m,rightClick:f,position:U,description:b,markPoint:A,options:e,mousemoveShowLabel:T,minHeight:O,maxHeight:E,showHeight:true,showLayer:true,showEntity:true,billboard:{image:c,show:true,width:t,height:o,horizontalOrigin:h,verticalOrigin:v,heightReference:V,disableDepthTestDistance:Number.POSITIVE_INFINITY,scaleByDistance:N},label:{text:D.toString(),font:H+"pt "+L,fillColor:R,showBackground:z,backgroundColor:P,show:B,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,pixelOffset:new Cesium.Cartesian2(t/2,0),verticalOrigin:Cesium.VerticalOrigin.BASELINE,heightReference:V,disableDepthTestDistance:Number.POSITIVE_INFINITY,scaleByDistance:x}});a._layer[a._layer.length]=Y;var G=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",G,I,k);return Y};e.prototype.addNew=function(e){var a=this;var r=new Cesium.PinBuilder;var l=e.mid?e.mid:"";var i=e.name?e.name:"default";var t=e.width?parseInt(e.width):30;var o=e.height?parseInt(e.height):30;var s=e.lon?parseFloat(e.lon):0;var n=e.lat?parseFloat(e.lat):0;var _=e.alt?parseFloat(e.alt):0;var u=e.color?e.color:Cesium.Color.YELLOW;var h=e.horizontalOrigin?e.horizontalOrigin:Cesium.HorizontalOrigin.CENTER;var v=e.verticalOrigin?e.verticalOrigin:Cesium.VerticalOrigin.CENTER;var c=e.url?e.url:r.fromColor(u,48).toDataURL();var d=e.leftClick?e.leftClick:null;var g=e.rightClick?e.rightClick:null;var m=e.src?e.src:"";var f=e.label?e.label:"";var b=e.labelSize?e.labelSize:14;var C=e.labelFamily?e.labelFamily:"sans-serif";var y=e.mousemoveShowLabel!==false;var w=e.nearFarScalarImage?e.nearFarScalarImage:null;var p=e.nearFarScalarLabel?e.nearFarScalarLabel:null;var S=new Cesium.NearFarScalar(150,1,15e5,1);var I=new Cesium.NearFarScalar(150,1,15e5,1);if(w&&w.length==4){S=new Cesium.NearFarScalar(w[0],w[1],w[2],w[3])}if(p&&p.length==4){I=new Cesium.NearFarScalar(p[0],p[1],p[2],p[3])}var k;if(e.labelColor){if(e.labelColor.indexOf("#")!=-1){k=Cesium.Color.fromCssColorString(e.labelColor)}else{k=e.labelColor}}else{k=Cesium.Color.WHITE}var O=e.labelShow!==false;var E=false;if(e.showBackground){E=e.showBackground}var D;if(e.backgroundColor){if(e.backgroundColor.indexOf("#")!=-1){D=Cesium.Color.fromCssColorString(e.backgroundColor)}else{D=e.backgroundColor}}else{D=Cesium.Color.BLUE}var H;var L;var T=e.clampMode?e.clampMode:0;if(T==0){H=Cesium.HeightReference.RELATIVE_TO_GROUND;L=Cesium.Cartesian3.fromDegrees(s,n)}else{H=Cesium.HeightReference.NONE;L=Cesium.Cartesian3.fromDegrees(s,n,_)}var F=a._viewer.entities.add({mid:l,name:i,src:m,leftClick:d,rightClick:g,position:L,options:e,mousemoveShowLabel:y,billboard:{image:c,show:true,width:t,height:o,horizontalOrigin:h,verticalOrigin:v,heightReference:H,disableDepthTestDistance:Number.POSITIVE_INFINITY,scaleByDistance:S},label:{text:f.toString(),font:b+"pt "+C,fillColor:k,showBackground:E,backgroundColor:D,show:O,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,pixelOffset:new Cesium.Cartesian2(t/2,0),verticalOrigin:Cesium.VerticalOrigin.BASELINE,heightReference:H,disableDepthTestDistance:Number.POSITIVE_INFINITY,scaleByDistance:I}});return F};e.prototype.revise=function(e,a){var r=this;for(var l=r._layer.length-1;l>=0;l--){if(r._layer[l]==e){var i=a.width?parseInt(a.width):r._layer[l]._billboard._width._value;var t=a.height?parseInt(a.height):r._layer[l]._billboard._height._value;var o=a.url?a.url:r._layer[l]._billboard._image._value;var s=Cesium.Cartographic.fromCartesian(r._layer[l]._position._value);var n=Cesium.Math.toDegrees(s.longitude);var _=Cesium.Math.toDegrees(s.latitude);var u=s.height;var h=a.lon?parseFloat(a.lon):n;var v=a.lat?parseFloat(a.lat):_;var c=a.alt?parseFloat(a.alt):u;var d=a.label?a.label:r._layer[l]._label._text._value;var g=r._layer[l]._label._show._value;if(!!a.labelShow===a.labelShow){g=a.labelShow}var m=r._layer[l].showEntity;if(!!a.show===a.show){m=a.show}var f={lon:h,lat:v,alt:c};r._layer[l]._billboard._width._value=i;r._layer[l]._billboard._height._value=t;r._layer[l]._billboard._image._value=o;r._layer[l]._position._value=Cesium.Cartesian3.fromDegrees(h,v,c);r._layer[l]._label._text._value=d;r._layer[l]._label._show._value=g;r._layer[l]._markPoint=f;r._layer[l].showEntity=m}}for(var l=r._layer_dataSource.length-1;l>=0;l--){if(r._layer_dataSource[l]==e){var i=a.width?parseInt(a.width):r._layer_dataSource[l]._billboard._width._value;var t=a.height?parseInt(a.height):r._layer_dataSource[l]._billboard._height._value;var o=a.url?a.url:r._layer_dataSource[l]._billboard._image._value;var s=Cesium.Cartographic.fromCartesian(r._layer_dataSource[l]._position._value);var n=Cesium.Math.toDegrees(s.longitude);var _=Cesium.Math.toDegrees(s.latitude);var u=s.height;var h=a.lon?parseFloat(a.lon):n;var v=a.lat?parseFloat(a.lat):_;var c=a.alt?parseFloat(a.alt):u;var m=r._layer_dataSource[l]._show;if(!!a.show===a.show){m=a.show}var f={lon:h,lat:v,alt:c};r._layer_dataSource[l]._billboard._width._value=i;r._layer_dataSource[l]._billboard._height._value=t;r._layer_dataSource[l]._billboard._image._value=o;r._layer_dataSource[l]._position._value=Cesium.Cartesian3.fromDegrees(h,v,c);r._layer_dataSource[l]._markPoint=f;r._layer_dataSource[l].show=m}}};e.prototype.reviseByMid=function(e,a){var r=this;for(var l=r._layer.length-1;l>=0;l--){if(r._layer[l].mid==e){var i=a.width?parseInt(a.width):r._layer[l]._billboard._width._value;var t=a.height?parseInt(a.height):r._layer[l]._billboard._height._value;var o=a.url?a.url:r._layer[l]._billboard._image._value;var s=Cesium.Cartographic.fromCartesian(r._layer[l]._position._value);var n=Cesium.Math.toDegrees(s.longitude);var _=Cesium.Math.toDegrees(s.latitude);var u=s.height;var h=a.lon?parseFloat(a.lon):n;var v=a.lat?parseFloat(a.lat):_;var c=a.alt?parseFloat(a.alt):u;var d=a.label?a.label:r._layer[l]._label._text._value;var g=r._layer[l]._label._show._value;if(!!a.labelShow===a.labelShow){g=a.labelShow}var m=r._layer[l]._show;if(!!a.show===a.show){m=a.show}var f={lon:h,lat:v,alt:c};r._layer[l]._billboard._width._value=i;r._layer[l]._billboard._height._value=t;r._layer[l]._billboard._image._value=o;r._layer[l]._position._value=Cesium.Cartesian3.fromDegrees(h,v,c);r._layer[l]._label._text._value=d;r._layer[l]._label._show._value=g;r._layer[l]._markPoint=f;r._layer[l].show=m}}for(var l=r._layer_dataSource.length-1;l>=0;l--){if(r._layer_dataSource[l].mid==e){var i=a.width?parseInt(a.width):r._layer_dataSource[l]._billboard._width._value;var t=a.height?parseInt(a.height):r._layer_dataSource[l]._billboard._height._value;var o=a.url?a.url:r._layer_dataSource[l]._billboard._image._value;var s=Cesium.Cartographic.fromCartesian(r._layer_dataSource[l]._position._value);var n=Cesium.Math.toDegrees(s.longitude);var _=Cesium.Math.toDegrees(s.latitude);var u=s.height;var h=a.lon?parseFloat(a.lon):n;var v=a.lat?parseFloat(a.lat):_;var c=a.alt?parseFloat(a.alt):u;var m=r._layer_dataSource[l]._show;if(!!a.show===a.show){m=a.show}var f={lon:h,lat:v,alt:c};r._layer_dataSource[l]._billboard._width._value=i;r._layer_dataSource[l]._billboard._height._value=t;r._layer_dataSource[l]._billboard._image._value=o;r._layer_dataSource[l]._position._value=Cesium.Cartesian3.fromDegrees(h,v,c);r._layer_dataSource[l]._markPoint=f;r._layer_dataSource[l].show=m}}};e.prototype.drawHandler=function(e){var a=this;a._options.draw=true;a._options.options=e;var r=e.handlerCallback?e.handlerCallback:null;a._options.handlerCallback=r};e.prototype.deactivateHandler=function(){var e=this;e._options.draw=false};e.prototype.remove=function(e){var a=this;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r]==e){var l=a._layer[r].catalog;var i=a._layer[r].subcatalog;var t=a._viewer.entities.remove(e);a._layer.splice(r,1);a._globe.layerManager._remove("entityLayer",l,i);return t}}for(var r=a._layer_dataSource.length-1;r>=0;r--){if(a._layer_dataSource[r]==e){var l=a._layer_dataSource[r].catalog;var i=a._layer_dataSource[r].subcatalog;var t=a._dataSource.entities.remove(e);a._layer_dataSource.splice(r,1);a._globe.layerManager._remove("entityLayer",l,i);return t}}};e.prototype.removeByMid=function(e){var a=this;var r=true;for(var l=a._layer.length-1;l>=0;l--){if(a._layer[l].mid==e){var i=a._layer[l].catalog;var t=a._layer[l].subcatalog;r=a._viewer.entities.remove(a._layer[l]);a._layer.splice(l,1);a._globe.layerManager._remove("entityLayer",i,t);if(!r){return r}}}for(var l=a._layer_dataSource.length-1;l>=0;l--){if(a._layer_dataSource[l].mid==e){var i=a._layer_dataSource[l].catalog;var t=a._layer_dataSource[l].subcatalog;r=a._dataSource.entities.remove(a._layer_dataSource[l]);a._layer_dataSource.splice(l,1);a._globe.layerManager._remove("entityLayer",i,t);if(!r){return r}}}return r};e.prototype.removeByName=function(e){var a=this;var r=true;for(var l=a._layer.length-1;l>=0;l--){if(a._layer[l].name==e){var i=a._layer[l].catalog;var t=a._layer[l].subcatalog;r=a._viewer.entities.remove(a._layer[l]);a._layer.splice(l,1);a._globe.layerManager._remove("entityLayer",i,t);if(!r){return r}}}for(var l=a._layer_dataSource.length-1;l>=0;l--){if(a._layer_dataSource[l].name==e){var i=a._layer_dataSource[l].catalog;var t=a._layer_dataSource[l].subcatalog;r=a._dataSource.entities.remove(a._layer_dataSource[l]);a._layer_dataSource.splice(l,1);a._globe.layerManager._remove("entityLayer",i,t);if(!r){return r}}}return r};e.prototype.getByMid=function(e){var a=this;var r=[];for(var l=a._layer.length-1;l>=0;l--){if(a._layer[l].mid==e){r.push(a._layer[l])}}for(var l=a._layer_dataSource.length-1;l>=0;l--){if(a._layer_dataSource[l].mid==e){r.push(a._layer_dataSource[l])}}return r};e.prototype.getByName=function(e){var a=this;var r=[];for(var l=a._layer.length-1;l>=0;l--){if(a._layer[l].name==e){r.push(a._layer[l])}}for(var l=a._layer_dataSource.length-1;l>=0;l--){if(a._layer_dataSource[l].name==e){r.push(a._layer_dataSource[l])}}return r};e.prototype.flashMark=function(e){var a=e.id?e.id:null;var r=e.img01?e.img01:null;var l=e.img02?e.img02:null;if(a==null||r==null||l==null){return}var i=this._viewer.entities.getById(a);var t=e.num;if(i){if(t%2===0){i.billboard.image=r}else{i.billboard.image=l}}};return e});