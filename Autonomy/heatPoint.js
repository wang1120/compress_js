define(["./heatmap"],function(e){function t(t){this._globe=t;this._viewer=t._viewer;this._globeId=t._globeId;this.viewshedLayers=null;this.WMP=new Cesium.WebMercatorProjection;this.defaults={useEntitiesIfAvailable:true,minCanvasSize:800,maxCanvasSize:2e3,radiusFactor:25,spacingFactor:1,maxOpacity:.9,minOpacity:.1,blur:.85,gradient:{".5":"blue",".65":"yellow",".8":"orange",".95":"red"}}}t.prototype.clear=function(){var t=this;if(t.viewshedLayers){t._viewer.imageryLayers.remove(t.viewshedLayers);t.viewshedLayers=null}};t.prototype.loadData=function(t){if(!t){return}var a=this;var e=0;var i=0;var r=0;var o=0;var n=0;var s=0;for(var h=0;h<t.length;h++){var u=t[h].lon;var d=t[h].lat;var f=t[h].value;t[h].x=u;t[h].y=d;if(h==0){r=u;n=u;o=d;s=d;e=f;i=f}else{r=Math.min(r,u);n=Math.max(n,u);o=Math.min(o,d);s=Math.max(s,d);e=Math.min(e,f);i=Math.max(i,f)}}var c={north:s,east:n,south:o,west:r};a.build(c);a.setWGS84Data(e,i,t)};t.prototype.build=function(t){var a=this;a._options={container:document.querySelector("#"+a._globeId)};a._id=a._getID();a._options.gradient=a._options.gradient?a._options.gradient:a.defaults.gradient;a._options.maxOpacity=a._options.maxOpacity?a._options.maxOpacity:a.defaults.maxOpacity;a._options.minOpacity=a._options.minOpacity?a._options.minOpacity:a.defaults.minOpacity;a._options.blur=a._options.blur?a._options.blur:a.defaults.blur;a._mbounds=a.wgs84ToMercatorBB(t);a._setWidthAndHeight(a._mbounds);a._options.radius=Math.round(a._options.radius?a._options.radius:a.width>a.height?a.width/a.defaults.radiusFactor:a.height/a.defaults.radiusFactor);a._spacing=a._options.radius*a.defaults.spacingFactor;a._xoffset=a._mbounds.west;a._yoffset=a._mbounds.south;a.width=Math.round(a.width+a._spacing*2);a.height=Math.round(a.height+a._spacing*2);a._mbounds.west-=a._spacing*a._factor;a._mbounds.east+=a._spacing*a._factor;a._mbounds.south-=a._spacing*a._factor;a._mbounds.north+=a._spacing*a._factor;a.bounds=a.mercatorToWgs84BB(a._mbounds);a._rectangle=Cesium.Rectangle.fromDegrees(a.bounds.west,a.bounds.south,a.bounds.east,a.bounds.north);a._container=a._getContainer(a.width,a.height,a._id);a._options.container=a._container;a._heatmap=e.create(a._options);a._container.children[0].setAttribute("id",a._id+"-hm")};t.prototype.setWGS84Data=function(t,a,e){var i=this;if(e&&e.length>0&&t!==null&&t!==false&&a!==null&&a!==false){var r=[];for(var o=0;o<e.length;o++){var n=e[o];var s=i.wgs84PointToHeatmapPoint(n);if(n.value||n.value===0){s.value=n.value}r.push(s)}return i.setData(t,a,r)}return false};t.prototype.wgs84PointToHeatmapPoint=function(t){var a=this;return a.mercatorPointToHeatmapPoint(a.wgs84ToMercator(t))};t.prototype.wgs84ToMercator=function(t){var a=this;var e=a.WMP.project(Cesium.Cartographic.fromDegrees(t.x,t.y));return{x:e.x,y:e.y}};t.prototype.mercatorPointToHeatmapPoint=function(t){var a=this;var e={};e.x=Math.round((t.x-a._xoffset)/a._factor+a._spacing);e.y=Math.round((t.y-a._yoffset)/a._factor+a._spacing);e.y=a.height-e.y;return e};t.prototype.setData=function(t,a,e){var i=this;if(e&&e.length>0&&t!==null&&t!==false&&a!==null&&a!==false){i._heatmap.setData({min:t,max:a,data:e});i.updateLayer();return true}return false};t.prototype.updateLayer=function(){var t=this;var a=t._heatmap._renderer.canvas.toDataURL("image/png");var e=t._viewer.imageryLayers;if(t.viewshedLayers){e.remove(t.viewshedLayers)}t.viewshedLayers=e.addImageryProvider(new Cesium.SingleTileImageryProvider({url:a,rectangle:t._rectangle}));t.viewshedLayers.alpha=.8};t.prototype._getID=function(t){var a=this;var e="";var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var r=0;r<(t?t:8);r++)e+=i.charAt(Math.floor(Math.random()*i.length));return e};t.prototype.wgs84ToMercatorBB=function(t){var a=this;var e=a.WMP.project(Cesium.Cartographic.fromDegrees(t.west,t.south));var i=a.WMP.project(Cesium.Cartographic.fromDegrees(t.east,t.north));return{north:i.y,east:i.x,south:e.y,west:e.x}};t.prototype._setWidthAndHeight=function(t){var a=this;a.width=t.east>0&&t.west<0?t.east+Math.abs(t.west):Math.abs(t.east-t.west);a.height=t.north>0&&t.south<0?t.north+Math.abs(t.south):Math.abs(t.north-t.south);a._factor=1;if(a.width>a.height&&a.width>a.defaults.maxCanvasSize){a._factor=a.width/a.defaults.maxCanvasSize;if(a.height/a._factor<a.defaults.minCanvasSize){a._factor=a.height/a.defaults.minCanvasSize}}else if(a.height>a.width&&a.height>a.defaults.maxCanvasSize){a._factor=a.height/a.defaults.maxCanvasSize;if(a.width/a._factor<a.defaults.minCanvasSize){a._factor=a.width/a.defaults.minCanvasSize}}else if(a.width<a.height&&a.width<a.defaults.minCanvasSize){a._factor=a.width/a.defaults.minCanvasSize;if(a.height/a._factor>a.defaults.maxCanvasSize){a._factor=a.height/a.defaults.maxCanvasSize}}else if(a.height<a.width&&a.height<a.defaults.minCanvasSize){a._factor=a.height/a.defaults.minCanvasSize;if(a.width/a._factor>a.defaults.maxCanvasSize){a._factor=a.width/a.defaults.maxCanvasSize}}a.width=a.width/a._factor;a.height=a.height/a._factor};t.prototype.mercatorToWgs84BB=function(t){var a=this;var e=a.WMP.unproject(new Cesium.Cartesian3(t.west,t.south));var i=a.WMP.unproject(new Cesium.Cartesian3(t.east,t.north));return{north:a.rad2deg(i.latitude),east:a.rad2deg(i.longitude),south:a.rad2deg(e.latitude),west:a.rad2deg(e.longitude)}};t.prototype._getContainer=function(t,a,e){var i=this;var r=document.createElement("div");if(e){r.setAttribute("id",e)}r.setAttribute("style","width: "+t+"px; height: "+a+"px; margin: 0px; display: none;");document.body.appendChild(r);return r};t.prototype.deg2rad=function(t){var a=t*(Math.PI/180);return a};t.prototype.rad2deg=function(t){var a=t/(Math.PI/180);return a};return t});