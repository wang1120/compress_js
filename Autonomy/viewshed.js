define([],function(){function e(e){var o=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this.viewshedOptions={draw:false,drawid:"",n:0,vertexLineList:[],towerHeight:0,endPoint:null};this.viewshedList=[];this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){var i=o._globe.getLonLatByPosition(e.position);if(o.viewshedOptions.draw&&o.viewshedOptions.drawid==""&&i!=null){o.viewshedOptions.vertexLineList=[];o.viewshedOptions.drawid=(new Date).valueOf();var t="toolset-id";var a={vname:"toolset-name",vid:t,spoint:null,epoint:null,marker:null,towerLine:null,infoWindow:null,viewshedLayers:null};var n=o._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(i.lon,i.lat),radius:0,ellipse:{semiMinorAxis:new Cesium.CallbackProperty(function(){return n.radius},false),semiMajorAxis:new Cesium.CallbackProperty(function(){return n.radius},false),material:Cesium.Color.BLUE.withAlpha(.1)}});var r=o._viewer.entities.add({polyline:{positions:new Cesium.CallbackProperty(function(){return o.viewshedOptions.vertexLineList},false),width:3,material:Cesium.Color.DARKRED.withAlpha(1)}});var s=o._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(i.lon,i.lat),distance:0,label:{text:new Cesium.CallbackProperty(function(){return(s.distance/1e3).toFixed(2)+"km"},false),font:"14pt sans-serif",fillColor:Cesium.Color.YELLOW,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,pixelOffset:new Cesium.Cartesian2(15,0),verticalOrigin:Cesium.VerticalOrigin.BASELINE,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND,disableDepthTestDistance:Number.POSITIVE_INFINITY}});a.circle=n;a.polyline=r;a.label=s;a.spoint=i;o.viewshedList.push(a)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var i=o._globe.getLonLatByPosition(e.endPosition);if(o.viewshedOptions.draw&&o.viewshedOptions.drawid!=""){var t=o.viewshedList[o.viewshedList.length-1];var a=t.spoint;var n=i;var r=CommonFunc.getDistance(a.lon,a.lat,n.lon,n.lat);t.label.distance=r;r=r<=15e3?r:15e3;t.circle.radius=r;t.label.position=Cesium.Cartesian3.fromDegrees(i.lon,i.lat);var s=[];s.push(a.lon);s.push(a.lat);s.push(a.alt);s.push(n.lon);s.push(n.lat);s.push(n.alt);o.viewshedOptions.vertexLineList=Cesium.Cartesian3.fromDegreesArrayHeights(s)}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this._handler.setInputAction(function(e){var i=o._globe.getLonLatByPosition(e.position);if(i.alt<0){i.alt=0}if(o.viewshedOptions.draw&&o.viewshedOptions.drawid!=""){o._executeDrawViewshed(o.viewshedList[o.viewshedList.length-1].circle.radius)}},Cesium.ScreenSpaceEventType.RIGHT_CLICK)}e.prototype.drawHandler=function(e){var i=this;i.viewshedOptions.draw=true;i.viewshedOptions.towerHeight=parseFloat(e)};e.prototype.clear=function(){var e=this;var i=[];var t=e.viewshedList.length;e.viewshedOptions.draw=false;for(var a=0;a<t;a++){var n=e.viewshedList[a];if(n.viewshedLayers!=null&&n.vname=="toolset-name"){e._viewer.imageryLayers.remove(n.viewshedLayers);e._globe.placeMark.remove(n.marker);e._viewer.entities.remove(n.towerLine);e._globe.infoWindow.removeById(n.infoWindow)}else{i.push(n)}}e.viewshedList.splice(0,t);e.viewshedList=i};e.prototype.removeById=function(e){var i=this;for(var t=0;t<i.viewshedList.length;t++){var a=i.viewshedList[t];if(a.vid==e){i._viewer.imageryLayers.remove(a.viewshedLayers);i._globe.placeMark.remove(a.marker);i._viewer.entities.remove(a.towerLine);i._globe.infoWindow.removeById(a.infoWindow);i.viewshedList.splice(t,1)}}};e.prototype.add=function(e){var i=this;var t=e.vid?e.vid:"add-vid";var a=e.lon?parseFloat(e.lon):0;var n=e.lat?parseFloat(e.lat):0;var r=e.name?e.name:"add-name";var s=e.radius?parseFloat(e.radius):0;var o=e.towerHeight?parseFloat(e.towerHeight):0;var l=e.callback?e.callback:null;var d={lon:a,lat:n};var v=[d];var h={spoint:d,radius:s,towerHeight:o,vid:t,vname:r,self:i,callback:l};i._globe.getAltByLonlat(v,i._callback,h)};e.prototype._callback=function(e,i){var t=this;var a={lon:i.spoint.lon,lat:i.spoint.lat,alt:e[0].alt};var n={vname:i.vname,vid:i.vid,spoint:a,epoint:null,marker:null,towerLine:null,infoWindow:null,viewshedLayers:null};i.self._executeViewshed(n,a,i.radius,i.towerHeight,i.callback)};e.prototype._executeDrawViewshed=function(e){var i=this;var t=i.viewshedOptions.towerHeight;var a=i.viewshedList[i.viewshedList.length-1];i._viewer.entities.remove(a.circle);i._viewer.entities.remove(a.polyline);i._viewer.entities.remove(a.label);var n=a.spoint;i._executeViewshed(a,n,e,t,null);i.viewshedOptions.draw=false;i.viewshedOptions.drawid=""};e.prototype._executeViewshed=function(g,L,C,y,_){var b=this;var e;var O;var I=b._globe.urlConfig.LOCALVIEWSHED;var i=CommonFunc.destinationVincenty(L.lon,L.lat,0,0,0,C);var t=CommonFunc.destinationVincenty(L.lon,L.lat,0,90,0,C);var a=Math.ceil((i.lat-L.lat)*3600);var n=Math.ceil((t.lon-L.lon)*3600);e=n;if(e%2!=0)e+=1;n=e;O=(parseFloat(C)/1e3).toFixed(2)+"km";var F="image"+(new Date).valueOf()+".png";var r={lon:L.lon,lat:L.lat,imgName:F,midNum:e,towerHeight:y,a:n,b:a};$.ajax({type:"post",url:I+"/viewshed/execute.do",data:r,async:false,success:function(e){if(e!==null){var e=JSON.parse(e);var i=e.percent;if(i!=-1){var t={lon:L.lon,lat:L.lat,width:10,height:10};g.marker=b._globe.placeMark.add(t);if(y>0){var a={lon:L.lon,lat:L.lat,alt:L.alt+y};var n=[L,a];var r=[];for(var s=0;s<n.length;s++){r.push(n[s].lon);r.push(n[s].lat);r.push(n[s].alt)}g.towerLine=b._viewer.entities.add({polyline:{positions:Cesium.Cartesian3.fromDegreesArrayHeights(r),material:new Cesium.PolylineDashMaterialProperty({color:Cesium.Color.YELLOW})}})}var o="<table><tr><td>视高：</td><td>"+y+"米"+"</td></tr>"+"<tr><td>半径：</td><td>"+O+"</td></tr>"+"<tr><td>经度：</td><td>"+L.lon.toFixed(4)+"度"+"</td></tr>"+"<tr><td>纬度：</td><td>"+L.lat.toFixed(4)+"度"+"</td></tr>"+"<tr><td>可视：</td><td>"+i.toFixed(2)+"%"+"</td></tr></table>";var l;if(a){l=a}else{l=L}var t={lonlat:l,des:o,width:170,height:125,showClose:false,title:"可视域信息",top:24};g.infoWindow=b._globe.infoWindow.build(t);var d=CommonFunc.destinationVincenty(L.lon,L.lat,0,0,0,C);var v=CommonFunc.destinationVincenty(L.lon,L.lat,0,90,0,C);var h=CommonFunc.destinationVincenty(L.lon,L.lat,0,180,0,C);var w=CommonFunc.destinationVincenty(L.lon,L.lat,0,270,0,C);var u=w.lon;var p=h.lat;var c=v.lon;var m=d.lat;var f=b._viewer.imageryLayers;g.viewshedLayers=f.addImageryProvider(new Cesium.SingleTileImageryProvider({url:I+"/static/viewshedImg/"+F,rectangle:Cesium.Rectangle.fromDegrees(u,p,c,m)}));g.viewshedLayers.alpha=.5;if(g.vname=="toolset-name"){b.viewshedList[b.viewshedList.length-1]=g}else{b.viewshedList.push(g)}if(_)_(true)}else{alert("此地区没有dem数据!")}}},error:function(){if(_)_(false)}})};return e});