define([],function(){function e(e){var y=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._showMenu=true;this._layer={draw:false,drawid:"",layer:this._globe._defaultLayer,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",mid:"",name:"default",type:"basic",clampMode:0,callback:null,rightClick:null,subset:[]};this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=y._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var t=Cesium.Cartographic.fromCartesian(y._viewer.scene.camera.position);e=t.height}else{e=Math.ceil(y._viewer.camera.positionCartographic.height)}for(var r=0;r<y._layer.subset.length;r++){if(e>=y._layer.subset[r].minHeight&&e<=y._layer.subset[r].maxHeight){y._layer.subset[r].showHeight=true}else{y._layer.subset[r].showHeight=false}if(y._layer.subset[r].showHeight&&y._layer.subset[r].showLayer&&y._layer.subset[r].showEntity){y._layer.subset[r].polygon.show=true;if(y._layer.subset[r].clampMode==0){y._layer.subset[r].polyline.show=true}}else{y._layer.subset[r].polygon.show=false;if(y._layer.subset[r].polyline){y._layer.subset[r].polyline.show=false}}}});this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){var a=y._globe.getLonLatByPosition(e.position);if(y._layer.draw){if(a.alt<0){a.alt=0}if(y._layer.drawid==""){var t={id:"newarrow",mid:y._layer.mid,name:y._layer.name,type:y._layer.type,layer:y._layer.layer,catalog:y._layer.catalog,subcatalog:y._layer.subcatalog,minHeight:y._layer.minHeight,maxHeight:y._layer.maxHeight,showHeight:true,showLayer:true,showEntity:true,clampMode:y._layer.clampMode,callback:y._layer.callback,polygon:null,polyline:null,points:[],vertexList:[],vertexLineList:[]};y._layer.subset[y._layer.subset.length]=t;y._layer.drawid="newarrow";var r=(new Date).getTime()+"a"+parseInt(100*Math.random());y._globe.layerManager._add("entityLayer",r,y._layer.catalog,y._layer.subcatalog)}var l;for(var i=0;i<y._layer.subset.length;i++){if(y._layer.subset[i].id==y._layer.drawid){l=y._layer.subset[i];break}}var o={lon:a.lon,lat:a.lat,alt:a.alt};l.points[l.points.length]=o;if(l.points.length==1){l.vertexList=[];l.vertexLineList=[];if(l.clampMode==0){l.polygon=y._viewer.entities.add({rightClick:y._layer.rightClick,polygon:{hierarchy:new Cesium.CallbackProperty(function(){return l.vertexList},false),material:Cesium.Color.RED.withAlpha(.5),height:2e3}});l.polyline=y._viewer.entities.add({polyline:{positions:new Cesium.CallbackProperty(function(){return l.vertexLineList},false),width:3,material:Cesium.Color.RED.withAlpha(1)}})}else{l.polygon=y._viewer.entities.add({rightClick:y._layer.rightClick,polygon:{hierarchy:new Cesium.CallbackProperty(function(){return l.vertexList},false),material:Cesium.Color.RED.withAlpha(.5)}});l.polyline=null}y._layer.drawid=l.id=l.polygon.id}else{var s=CommonFunc.getArrowPointList(l.points,"polygon",l.type);l.vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(s);if(l.clampMode==0){var n=CommonFunc.getArrowPointList(l.points,"polyline",l.type);l.vertexLineList=Cesium.Cartesian3.fromDegreesArrayHeights(n)}if(l.points.length==3){y._layer.drawid="";if(l.callback){l.callback(l)}}}}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=y._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}var t={lon:a.lon,lat:a.lat,alt:a.alt};if(y._layer.draw){var r;for(var l=0;l<y._layer.subset.length;l++){if(y._layer.subset[l].id==y._layer.drawid){r=y._layer.subset[l];r.points[r.points.length]=t;break}}y._layer.drawid="";if(r.callback){r.callback(r)}}},Cesium.ScreenSpaceEventType.RIGHT_CLICK);this._handler.setInputAction(function(e){var a=y._globe.getLonLatByPosition(e.endPosition);if(y._layer.draw&&y._layer.drawid!=""){var t;for(var r=0;r<y._layer.subset.length;r++){if(y._layer.subset[r].id==y._layer.drawid){t=y._layer.subset[r];break}}if(t.points.length>0){if(a.alt<0){a.alt=0}var l={lon:a.lon,lat:a.lat,alt:a.alt};var i=t.points.slice(0);i[i.length]=l;var o=CommonFunc.getArrowPointList(i,"polygon",t.type);t.vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(o);if(t.clampMode==0){var s=CommonFunc.getArrowPointList(i,"polyline",t.type);t.vertexLineList=Cesium.Cartesian3.fromDegreesArrayHeights(s)}}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}e.prototype.add=function(e){var a=this;var t=e.mid?e.mid:"";var r=e.name?e.name:"";var l=e.wlpha?parseFloat(e.wlpha):1;var i=e.clampMode?e.clampMode:0;var o=e.type?e.type:"basic";var s=e.height?parseInt(e.height):2e3;var n=e.rightClick?e.rightClick:null;var y=e.color?e.color:Cesium.Color.RED;var _=e.pointList?e.pointList:[];var g=e.layer?e.layer:a._globe._defaultLayer;var u=e.catalog?e.catalog:a._catalog;var c=e.subcatalog?e.subcatalog:a._subcatalog;var h=e.minHeight?e.minHeight:a._minHeight;var m=e.maxHeight?e.maxHeight:a._maxHeight;var d,p;var b=CommonFunc.getArrowPointList(_,"polygon",o);d=Cesium.Cartesian3.fromDegreesArrayHeights(b);if(i==0){var v=CommonFunc.getArrowPointList(_,"polyline",o);p=Cesium.Cartesian3.fromDegreesArrayHeights(v)}var f,w;if(i==0){f=a._viewer.entities.add({mid:t,name:r,options:e,rightClick:n,polygon:{hierarchy:d,material:y.withAlpha(l),height:s}});w=a._viewer.entities.add({mid:t,name:r,options:e,polyline:{positions:p,width:3,material:y.withAlpha(1)}})}else{f=a._viewer.entities.add({mid:t,name:r,options:e,rightClick:n,polygon:{hierarchy:d,material:y.withAlpha(l)}});w=null}var C={id:f.id,mid:t,name:r,type:o,layer:g,catalog:u,subcatalog:c,minHeight:h,maxHeight:m,showHeight:true,showLayer:true,showEntity:true,clampMode:i,callback:null,polygon:f,polyline:w,points:_,vertexList:d,vertexLineList:p};a._layer.subset[a._layer.subset.length]=C;var H=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",H,u,c);return C};e.prototype.drawHandler=function(e){var a=this;var t=e.mid?e.mid:"";var r=e.name?e.name:"default";var l=e.type?e.type:"basic";var i=e.clampMode?e.clampMode:0;var o=e.callback?e.callback:null;var s=e.setMenu?e.setMenu:null;var n=e.layer?e.layer:a._globe._defaultLayer;var y=e.catalog?e.catalog:a._catalog;var _=e.subcatalog?e.subcatalog:a._subcatalog;var g=e.minHeight?e.minHeight:a._minHeight;var u=e.maxHeight?e.maxHeight:a._maxHeight;var c=e.rightClick?e.rightClick:null;a._layer.draw=true;a._layer.drawid="";a._layer.mid=t;a._layer.name=r;a._layer.type=l;a._layer.clampMode=i;a._layer.callback=o;a._layer.rightClick=c;a._layer.layer=n;a._layer.catalog=y;a._layer.subcatalog=_;a._layer.minHeight=g;a._layer.maxHeight=u;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.deactivateHandler=function(){var e=this;e._layer.draw=false;e._layer.drawid="";e._layer.mid="";e._layer.name="default";e._layer.type="basic";e._layer.clampMode=0;e._layer.callback=null;e._layer.layer=e._globe._defaultLayer;e._layer.catalog=e._catalog;e._layer.subcatalog=e._subcatalog;e._layer.minHeight=e._minHeight;e._layer.maxHeight=e._maxHeight;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;var t;for(var r=a._layer.subset.length-1;r>=0;r--){if(a._layer.subset[r].id==e.id){var l=a._layer.subset[r].catalog;var i=a._layer.subset[r].subcatalog;t=a._viewer.entities.remove(a._layer.subset[r].polygon);if(!t){break}if(e.clampMode==0){t=a._viewer.entities.remove(a._layer.subset[r].polyline);if(!t){break}}a._layer.subset.splice(r,1);a._globe.layerManager._remove("entityLayer",l,i)}}a._layer.draw=false;a._layer.drawid="";a._layer.name="default";a._layer.type="basic";a._layer.clampMode=0;a._layer.callback=null;a._layer.layer=a._globe._defaultLayer;a._layer.catalog=a._catalog;a._layer.subcatalog=a._subcatalog;a._layer.minHeight=a._minHeight;a._layer.maxHeight=a._maxHeight;return t};e.prototype.removeByMid=function(e){var a=this;var t=true;for(var r=a._layer.subset.length-1;r>=0;r--){if(a._layer.subset[r].mid==e){var l=a._layer.subset[r].catalog;var i=a._layer.subset[r].subcatalog;t=a._viewer.entities.remove(a._layer.subset[r].polygon);if(!t){break}if(arrow.clampMode==0){t=a._viewer.entities.remove(a._layer.subset[r].polyline);if(!t){break}}a._layer.subset.splice(r,1);a._globe.layerManager._remove("entityLayer",l,i)}}a._layer.draw=false;a._layer.drawid="";a._layer.name="default";a._layer.type="basic";a._layer.clampMode=0;a._layer.callback=null;a._layer.layer=a._globe._defaultLayer;a._layer.catalog=a._catalog;a._layer.subcatalog=a._subcatalog;a._layer.minHeight=a._minHeight;a._layer.maxHeight=a._maxHeight;return t};e.prototype.removeByName=function(e){var a=this;var t=true;for(var r=a._layer.subset.length-1;r>=0;r--){if(a._layer.subset[r].name==e){var l=a._layer.subset[r].catalog;var i=a._layer.subset[r].subcatalog;t=a._viewer.entities.remove(a._layer.subset[r].polygon);if(!t){break}if(arrow.clampMode==0){t=a._viewer.entities.remove(a._layer.subset[r].polyline);if(!t){break}}a._layer.subset.splice(r,1);a._globe.layerManager._remove("entityLayer",l,i)}}a._layer.draw=false;a._layer.drawid="";a._layer.name="default";a._layer.type="basic";a._layer.clampMode=0;a._layer.callback=null;a._layer.layer=a._globe._defaultLayer;a._layer.catalog=a._catalog;a._layer.subcatalog=a._subcatalog;a._layer.minHeight=a._minHeight;a._layer.maxHeight=a._maxHeight;return t};e.prototype.getByMid=function(e){var a=this;var t=[];for(var r=a._layer.subset.length-1;r>=0;r--){if(a._layer.subset[r].mid==e){t[t.length]=a._layer.subset[r]}}return t};e.prototype.getByName=function(e){var a=this;var t=[];for(var r=a._layer.subset.length-1;r>=0;r--){if(a._layer.subset[r].name==e){t[t.length]=a._layer.subset[r]}}return t};return e});