define([],function(){function e(e){var H=this;this._globe=e;this._viewer=e._viewer;this._scene=e._viewer.scene;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._layer=[];this._options={draw:false,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",handlerCallback:null,options:null,drawid:""};this._isdrag=false;this._dragNun=0;this._dragObjNun=0;this._dragList=[];this._positionList=[];this._showMenu=true;this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=H._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var r=Cesium.Cartographic.fromCartesian(H._viewer.scene.camera.position);e=r.height}else{e=Math.ceil(H._viewer.camera.positionCartographic.height)}for(var t=0;t<H._layer.length;t++){if(e>=H._layer[t].minHeight&&e<=H._layer[t].maxHeight){H._layer[t].showHeight=true}else{H._layer[t].showHeight=false}if(H._layer[t].showHeight&&H._layer[t].showLayer&&H._layer[t].showEntity){}else{H._layer[t].polygon.show=false;H._layer[t].polyline.show=false}}});this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){var a=H._globe.getLonLatByPosition(e.position);if(H._options.draw){var r={};for(var t in H._options.options){if(t!="color"&&t!="layer"){r[t]=typeof H._options.options[t]==="object"?deepCoyp(H._options.options[t]):H._options.options[t]}}if(H._options.drawid==""){var i=r.mid?r.mid:"";var o=r.name?r.name:"default";var n=r.wlpha?r.wlpha:.3;var l=r.clampMode?r.clampMode:0;var s=r.height?r.height:2e3;var p=r.rightClick?r.rightClick:null;var _=H._options.options.color?H._options.options.color:Cesium.Color.fromCssColorString("#66cccc");var h=H._options.options.colorBorder?H._options.options.colorBorder:Cesium.Color.fromCssColorString("#66cccc");var g=H._options.options.layer?H._options.options.layer:H._globe._defaultLayer;var y=r.catalog?r.catalog:H._catalog;var u=r.subcatalog?r.subcatalog:H._subcatalog;var c=r.minHeight?r.minHeight:H._minHeight;var d=r.maxHeight?r.maxHeight:H._maxHeight;var v=[a];var m={mid:i,name:o,polygon:null,polyline:null,pointList:v,vertexList:null,vertexLineList:null,layer:g,catalog:y,subcatalog:u,minHeight:c,maxHeight:d,showHeight:true,showLayer:true,showEntity:true,clampMode:l};if(l==0){m.polygon=H._viewer.entities.add({mid:i,name:o,options:r,show:false,rightClick:p,polygon:{hierarchy:new Cesium.CallbackProperty(function(){return m.vertexList},false),material:_.withAlpha(n),height:s}});m.polyline=H._viewer.entities.add({mid:i,name:o,options:r,polyline:{positions:new Cesium.CallbackProperty(function(){return m.vertexLineList},false),width:3,material:h}})}else{m.polygon=H._viewer.entities.add({mid:i,name:o,options:r,show:false,rightClick:p,polygon:{hierarchy:new Cesium.CallbackProperty(function(){return m.vertexList},false),material:_.withAlpha(n)}});m.polyline=H._viewer.entities.add({mid:i,name:o,options:r,corridor:{positions:new Cesium.CallbackProperty(function(){return m.vertexLineList},false),width:40,material:h}})}H._layer[H._layer.length]=m;H._options.drawid=m.polygon.id;var f=(new Date).getTime()+"a"+parseInt(100*Math.random());H._globe.layerManager._add("entityLayer",f,y,u)}else{for(var C=0;C<H._layer.length;C++){if(H._layer[C].polygon.id==H._options.drawid){H._layer[C].pointList[H._layer[C].pointList.length]=a;var w=new Array;var L=new Array;for(var b=0;b<H._layer[C].pointList.length;b++){w.push(H._layer[C].pointList[b].lon);w.push(H._layer[C].pointList[b].lat);w.push(H._layer[C].pointList[b].alt+200);L.push(H._layer[C].pointList[b].lon);L.push(H._layer[C].pointList[b].lat);L.push(2e3)}L.push(H._layer[C].pointList[0].lon);L.push(H._layer[C].pointList[0].lat);L.push(2e3);H._layer[C].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(w);H._layer[C].vertexLineList=Cesium.Cartesian3.fromDegreesArrayHeights(L)}}}}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=H._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}if(H._options.draw){if(H._options.handlerCallback){for(var r=0;r<H._layer.length;r++){if(H._layer[r].polygon.id==H._options.drawid){H._layer[r].pointList[H._layer[r].pointList.length]=a;var t=H._layer[r].polygon.options;var i=t.clampMode?t.clampMode:0;H._layer[r].polygon.show=true;if(i==1){H._layer[r].polyline.show=true}H._options.drawid="";H._options.handlerCallback(H._layer[r]);break}}}else{H._options.drawid=""}}},Cesium.ScreenSpaceEventType.RIGHT_CLICK);this._handler.setInputAction(function(e){var a=H._globe.getLonLatByPosition(e.endPosition);if(H._options.draw){for(var r=0;r<H._layer.length;r++){if(H._layer[r].polygon.id==H._options.drawid){var t=H._layer[r].pointList.slice(0);t[t.length]=a;var i=new Array;var o=new Array;for(var n=0;n<t.length;n++){i.push(t[n].lon);i.push(t[n].lat);i.push(t[n].alt);o.push(t[n].lon);o.push(t[n].lat);o.push(2e3)}if(t.length>2){o.push(t[0].lon);o.push(t[0].lat);o.push(2e3)}H._layer[r].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(i);H._layer[r].vertexLineList=Cesium.Cartesian3.fromDegreesArrayHeights(o)}}}else if(H._isdrag){var a=H._globe.getLonLatByPosition(e.endPosition);H._dragList[H._dragObjNun].position=Cesium.Cartesian3.fromDegrees(a.lon,a.lat);H._layer[H._dragNun].pointList[H._dragObjNun]=a;var l=H._layer[H._dragNun].pointList;var s=2e3;var p=[];var _=[];var i=new Array;var o=new Array;for(var r=0;r<l.length;r++){i.push(l[r].lon);i.push(l[r].lat);i.push(l[r].alt);o.push(l[r].lon);o.push(l[r].lat);o.push(s)}p=Cesium.Cartesian3.fromDegreesArrayHeights(i);o.push(l[0].lon);o.push(l[0].lat);o.push(s);_=Cesium.Cartesian3.fromDegreesArrayHeights(o);H._layer[H._dragNun].vertexList=p;H._layer[H._dragNun].vertexLineList=_}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this._handler.setInputAction(function(e){var a=H._viewer.scene.pick(e.position);if(Cesium.defined(a)){if(a.id){if(a.id.drag){H._isdrag=true;H._scene.screenSpaceCameraController.enableRotate=false;H._scene.screenSpaceCameraController.enableTranslate=false;H._scene.screenSpaceCameraController.enableZoom=false;H._scene.screenSpaceCameraController.enableTilt=false;H._scene.screenSpaceCameraController.enableLook=false;document.getElementById(H._globeId).style.cursor="pointer";for(var r=0;r<H._dragList.length;r++){if(H._dragList[r].obj==a.id){H._dragObjNun=r}}}}}},Cesium.ScreenSpaceEventType.LEFT_DOWN);this._handler.setInputAction(function(e){if(H._isdrag){H._isdrag=false;H._scene.screenSpaceCameraController.enableRotate=true;H._scene.screenSpaceCameraController.enableTranslate=true;H._scene.screenSpaceCameraController.enableZoom=true;H._scene.screenSpaceCameraController.enableTilt=true;H._scene.screenSpaceCameraController.enableLook=true;document.getElementById(H._globeId).style.cursor="default";H._dragObjNun=0}},Cesium.ScreenSpaceEventType.LEFT_UP)}e.prototype.editByHandler=function(e){var a=this;a._clearDrag();for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r]==e){a._dragNun=r;break}}var t=a._layer[a._dragNun].pointList;for(var r=0;r<t.length;r++){a._addDrag(t[r])}};e.prototype.editByHandlerEnd=function(){var e=this;e._clearDrag()};e.prototype._clearDrag=function(){var e=this;for(var a=e._dragList.length-1;a>=0;a--){e._viewer.entities.remove(e._dragList[a].obj);e._dragList.splice(a,1)}e._dragList=[]};e.prototype._addDrag=function(e){var a=this;var r={obj:null,position:null};r.position=Cesium.Cartesian3.fromDegrees(e.lon,e.lat);r.obj=a._viewer.entities.add({drag:true,position:new Cesium.CallbackProperty(function(){return r.position},false),ellipse:{semiMinorAxis:150,semiMajorAxis:150,material:Cesium.Color.RED.withAlpha(1)}});a._dragList[a._dragList.length]=r};e.prototype.add=function(e){var a=this;var r=e.mid?e.mid:"";var t=e.name?e.name:"default";var i=e.wlpha?parseFloat(e.wlpha):.5;var o=e.clampMode?e.clampMode:0;var n=e.height?parseInt(e.height):2e3;var l=e.alt?parseInt(e.alt):20;var s=e.rightClick?e.rightClick:null;var p=e.color?e.color:Cesium.Color.BLUE;var _=e.colorBorder?e.colorBorder:Cesium.Color.GREEN;var h=e.pointList?e.pointList:[];var g=e.layer?e.layer:a._globe._defaultLayer;var y=e.catalog?e.catalog:a._catalog;var u=e.subcatalog?e.subcatalog:a._subcatalog;var c=e.minHeight?e.minHeight:a._minHeight;var d=e.maxHeight?e.maxHeight:a._maxHeight;var v=[];var m=[];var f=[];var C=[];for(var w=0;w<h.length;w++){f.push(h[w].lon);f.push(h[w].lat);if(h[w].alt){f.push(h[w].alt)}else{f.push(l)}C.push(h[w].lon);C.push(h[w].lat);C.push(n)}var L={mid:r,name:t,polygon:null,polyline:null,pointList:h,layer:g,catalog:y,subcatalog:u,minHeight:c,maxHeight:d,showHeight:true,showLayer:true,showEntity:true,clampMode:o};if(o==0){L.polygon=a._viewer.entities.add({mid:r,name:t,options:e,rightClick:s,polygon:{hierarchy:Cesium.Cartesian3.fromDegreesArrayHeights(f),material:p.withAlpha(i),height:n,outline:true,outlineColor:Cesium.Color.BLACK}})}else{L.polygon=a._viewer.entities.add({mid:r,name:t,options:e,rightClick:s,polygon:{hierarchy:Cesium.Cartesian3.fromDegreesArrayHeights(f),material:p.withAlpha(i),outline:true,outlineColor:Cesium.Color.BLACK}});L.polyline=a._viewer.entities.add({mid:r,name:t,options:e,show:false,polyline:{positions:Cesium.Cartesian3.fromDegreesArrayHeights(C),width:3,material:_}})}a._layer[a._layer.length]=L;var b=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",b,y,u);return L};e.prototype.drawHandler=function(e){var a=this;a._options.draw=true;a._options.drawid="";a._options.options=e;handlerCallback=e.handlerCallback?e.handlerCallback:null;a._options.handlerCallback=handlerCallback;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.deactivateHandler=function(){var e=this;e._options.draw=false;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].polygon==e){var t=a._layer[r].catalog;var i=a._layer[r].subcatalog;var o=a._viewer.entities.remove(a._layer[r].polygon);o=a._viewer.entities.remove(a._layer[r].polyline);a._layer.splice(r,1);a._globe.layerManager._remove("entityLayer",t,i);return o}}};e.prototype.removeByMid=function(e){var a=this;var r=true;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.mid==e){var i=a._layer[t].catalog;var o=a._layer[t].subcatalog;r=a._viewer.entities.remove(a._layer[t].polygon);r=a._viewer.entities.remove(a._layer[t].polyline);a._layer.splice(t,1);a._globe.layerManager._remove("entityLayer",i,o);if(!r){return r}}}return r};e.prototype.removeByName=function(e){var a=this;var r=true;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.name==e){var i=a._layer[t].catalog;var o=a._layer[t].subcatalog;r=a._viewer.entities.remove(a._layer[t].polygon);r=a._viewer.entities.remove(a._layer[t].polyline);a._layer.splice(t,1);a._globe.layerManager._remove("entityLayer",i,o);if(!r){return r}}}return r};e.prototype.getByMid=function(e){var a=this;var r=[];for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.mid==e){r[r.length]=a._layer[t].polygon}}return r};e.prototype.getByName=function(e){var a=this;var r=[];for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.name==e){r[r.length]=a._layer[t].polygon}}return r};return e});