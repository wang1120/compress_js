define([],function(){function n(e){var r=this;this._globe=e;this._viewer=e._viewer;this._scene=e._viewer.scene;this._globeId=e._globeId;this._layer=[]}n.prototype.add=function(e,r){var y=this;var v,f;var t=document.getElementById(e);var a=t.files;var d=r.callback?r.callback:null;if(a&&a.length>0){v=a[0].name;var o=v.split(".")[1];if(o!="shp"){d("error","文件格式错误");return}f=window.URL.createObjectURL(a[0])}else{if(d){d("error","文件选择错误");return}else{console.log("shp error:"+"文件选择错误");return}}var _=r.lineWidth?r.lineWidth:50;var C=r.color?r.color:Cesium.Color.GREEN;var w=r.lineColor?r.lineColor:Cesium.Color.RED;this.load(f,function(e){var r=[];var t=[];var a=[];var o;var n=e.shapeType;var s=(new Date).getTime()+"a"+parseInt(100*Math.random());if(n==1){o=y._scene.primitives.add(new Cesium.PointPrimitiveCollection);y._globe.layerManager._add("shpLayer",s,v)}for(var l=0;l<e.records.length;l++){var i;if(n==0){console.log("shp shapeType:"+n);return}else if(n==1){var p=e.records[l].shape.content.points;var h=o.add({position:Cesium.Cartesian3.fromDegrees(p[0],p[1]),color:C});h.url=f;h.name=v;h.lid=s;y._layer[y._layer.length]=h}else if(n==3){var u=[];var p=e.records[l].shape.content.points;for(var c=0;c<p.length;c++){u[u.length]=p[c]}var g=t.length-1;if(l%1e3==0){g=t.length;t[t.length]=[]}t[g].push(new Cesium.GeometryInstance({geometry:new Cesium.CorridorGeometry({vertexFormat:Cesium.VertexFormat.POSITION_ONLY,positions:Cesium.Cartesian3.fromDegreesArray(u),width:_}),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(w)}}))}else if(n==5){var u=[];var p=e.records[l].shape.content.points;for(var c=0;c<p.length;c++){u[u.length]=p[c]}r.push(new Cesium.GeometryInstance({geometry:new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(Cesium.Cartesian3.fromDegreesArray(u))}),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(C)}}));var g=t.length-1;if(l%1e3==0){g=t.length;t[t.length]=[]}t[g].push(new Cesium.GeometryInstance({geometry:new Cesium.CorridorGeometry({vertexFormat:Cesium.VertexFormat.POSITION_ONLY,positions:Cesium.Cartesian3.fromDegreesArray(u),width:_}),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(w)}}))}else if(n==8){console.log("shp shapeType:"+n);return}else if(n==11){console.log("shp shapeType:"+n);return}else if(n==13){console.log("shp shapeType:"+n);return}else if(n==15){console.log("shp shapeType:"+n);return}else if(n==18){console.log("shp shapeType:"+n);return}else if(n==21){console.log("shp shapeType:"+n);return}else if(n==23){console.log("shp shapeType:"+n);return}else if(n==25){console.log("shp shapeType:"+n);return}else if(n==28){console.log("shp shapeType:"+n);return}else if(n==31){console.log("shp shapeType:"+n);return}}if(n==1){}else if(n==3){for(var l=0;l<t.length;l++){var m=new Cesium.GroundPrimitive({geometryInstances:t[l],appearance:new Cesium.PerInstanceColorAppearance});m.url=f;m.name=v;m.lid=s;y._layer[y._layer.length]=m;y._scene.primitives.add(m)}y._globe.layerManager._add("shpLayer",s,v)}else if(n==5){var m=new Cesium.GroundPrimitive({geometryInstances:r,appearance:new Cesium.PerInstanceColorAppearance});m.url=f;m.name=v;m.lid=s;y._layer[y._layer.length]=m;y._scene.primitives.add(m);for(var l=0;l<t.length;l++){var m=new Cesium.GroundPrimitive({geometryInstances:t[l],appearance:new Cesium.PerInstanceColorAppearance});m.url=f;m.name=v;m.lid=s;y._layer[y._layer.length]=m;y._scene.primitives.add(m)}y._globe.layerManager._add("shpLayer",s,v)}if(d){d(s,v,e)}},function(e){if(d){d("error","error",e)}else{console.log("shp error:"+e)}})};n.prototype.removeByLid=function(e){var r=this;for(var t=r._layer.length-1;t>=0;t--){if(r._layer[t].lid==e){var a=r._scene.primitives.remove(r._layer[t]);r._layer.splice(t,1)}}r._globe.layerManager._remove("shpLayer",e)};n.prototype.removeByName=function(e){var r=this;var t;for(var a=r._layer.length-1;a>=0;a--){if(r._layer[a].name==e){t=r._layer[a].lid;var o=r._scene.primitives.remove(r._layer[a]);r._layer.splice(a,1)}}r._globe.layerManager._remove("shpLayer",t)};n.prototype.removeByUrl=function(e){var r=this;var t;for(var a=r._layer.length-1;a>=0;a--){if(r._layer[a].url==e){t=r._layer[a].lid;var o=r._scene.primitives.remove(r._layer[a]);r._layer.splice(a,1)}}r._globe.layerManager._remove("shpLayer",t)};n.prototype.load=function(e,r,t){var a=this;var o=new XMLHttpRequest;o.responseType="arraybuffer";o.onload=function(){var e=new n(a._globe).parse(o.response);r(e)};o.onerror=t;o.open("GET",e);o.send(null)};n.prototype.parse=function(e){var r={};var t=new DataView(e);var a=0;r.fileCode=t.getInt32(a,false);if(r.fileCode!=9994){throw new Error("Unknown file code: "+r.fileCode)}a+=6*4;r.wordLength=t.getInt32(a,false);r.byteLength=r.wordLength*2;a+=4;r.version=t.getInt32(a,true);a+=4;r.shapeType=t.getInt32(a,true);a+=4;r.minX=t.getFloat64(a,true);r.minY=t.getFloat64(a+8,true);r.maxX=t.getFloat64(a+16,true);r.maxY=t.getFloat64(a+24,true);r.minZ=t.getFloat64(a+32,true);r.maxZ=t.getFloat64(a+40,true);r.minM=t.getFloat64(a+48,true);r.maxM=t.getFloat64(a+56,true);a+=8*8;r.records=[];while(a<r.byteLength){var o={};o.number=t.getInt32(a,false);a+=4;o.length=t.getInt32(a,false);a+=4;try{o.shape=this.parseShape(t,a,o.length)}catch(e){console.log(e,o)}a+=o.length*2;r.records.push(o)}return r};n.prototype.parseShape=function(e,r,t){var a=0,o=null;var n={};n.type=e.getInt32(r,true);r+=4;var s=t*2;switch(n.type){case SHP.NULL:break;case SHP.POINT:n.content={x:e.getFloat64(r,true),y:e.getFloat64(r+8,true)};break;case SHP.POLYLINE:case SHP.POLYGON:o=n.content={minX:e.getFloat64(r,true),minY:e.getFloat64(r+8,true),maxX:e.getFloat64(r+16,true),maxY:e.getFloat64(r+24,true),parts:new Int32Array(e.getInt32(r+32,true)),points:new Float64Array(e.getInt32(r+36,true)*2)};r+=40;for(a=0;a<o.parts.length;a++){o.parts[a]=e.getInt32(r,true);r+=4}for(a=0;a<o.points.length;a++){o.points[a]=e.getFloat64(r,true);r+=8}break;case 8:case 11:case 13:case 15:case 18:case 21:case 23:case 25:case 28:case 31:throw new Error("Shape type not supported: "+n.type+":"+ +SHP.getShapeName(n.type));default:throw new Error("Unknown shape type at "+(r-4)+": "+n.type)}return n};SHP={NULL:0,POINT:1,POLYLINE:3,POLYGON:5};SHP.getShapeName=function(e){for(name in this){if(e===this[name]){return name}}};return n});