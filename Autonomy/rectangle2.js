define([],function(){function e(e){var w=this;this._globe=e;this._viewer=e._viewer;this._scene=e._viewer.scene;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._layer=[];this._options={draw:false,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",handlerCallback:null,options:null,drawid:""};this._isdrag=false;this._dragNun=0;this._dragObjNun=0;this._dragList=[];this._positionList=[];this._showMenu=true;this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=w._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var r=Cesium.Cartographic.fromCartesian(w._viewer.scene.camera.position);e=r.height}else{e=Math.ceil(w._viewer.camera.positionCartographic.height)}for(var t=0;t<w._layer.length;t++){if(e>=w._layer[t].minHeight&&e<=w._layer[t].maxHeight){w._layer[t].showHeight=true}else{w._layer[t].showHeight=false}if(w._layer[t].showHeight&&w._layer[t].showLayer&&w._layer[t].showEntity){w._layer[t].polygon.show=true;if(w._layer[t].clampMode==0){w._layer[t].polyline.show=true}}else{w._layer[t].polygon.show=false;w._layer[t].polyline.show=false}}});this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);var b=function(e){var a=w._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}if(w._options.draw){if(w._options.handlerCallback){for(var r=0;r<w._layer.length;r++){var t=w._layer[r];if(t.polygon.id==w._options.drawid){var o=t.polygon.options;var i=o.clampMode?o.clampMode:0;t.polygon.show=true;if(i==1){t.polyline.show=true}w._options.drawid="";w._options.handlerCallback(t);break}}}else{w._options.drawid=""}}};this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.position);if(w._options.draw){var r={};for(var t in w._options.options){if(t!="color"&&t!="layer"){r[t]=typeof w._options.options[t]==="object"?deepCoyp(w._options.options[t]):w._options.options[t]}}if(w._options.drawid==""){var o=r.mid?r.mid:"";var i=r.name?r.name:"default";var n=r.wlpha?r.wlpha:.3;var l=r.clampMode?r.clampMode:0;var s=r.height?r.height:2e3;var p=r.rightClick?r.rightClick:null;var _=w._options.options.color?w._options.options.color:Cesium.Color.fromCssColorString("#66cccc");var h=w._options.options.colorBorder?w._options.options.colorBorder:Cesium.Color.fromCssColorString("#66cccc");var c=w._options.options.layer?w._options.options.layer:w._globe._defaultLayer;var u=r.catalog?r.catalog:w._catalog;var g=r.subcatalog?r.subcatalog:w._subcatalog;var y=r.minHeight?r.minHeight:w._minHeight;var d=r.maxHeight?r.maxHeight:w._maxHeight;var v=[a];var f={mid:o,name:i,polygon:null,polyline:null,pointList:v,vertexList:null,vertexLineList:null,layer:c,catalog:u,subcatalog:g,minHeight:y,maxHeight:d,showHeight:true,showLayer:true,showEntity:true,clampMode:l};var m={hierarchy:new Cesium.CallbackProperty(function(){return f.vertexList},false),material:_.withAlpha(n)};if(l==0){m.height=s;f.polyline=w._viewer.entities.add({mid:o,name:i,options:r,polyline:{positions:new Cesium.CallbackProperty(function(){return f.vertexLineList},false),width:2,material:h}})}else{f.polyline=w._viewer.entities.add({mid:o,name:i,options:r,corridor:{positions:new Cesium.CallbackProperty(function(){return f.vertexLineList},false),width:50,material:h}})}f.polygon=w._viewer.entities.add({mid:o,name:i,options:r,show:false,rightClick:p,polygon:m});w._layer[w._layer.length]=f;w._options.drawid=f.polygon.id;var C=(new Date).getTime()+"a"+parseInt(100*Math.random())}else{b(e)}}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){b(e)},Cesium.ScreenSpaceEventType.RIGHT_CLICK);var n=w._options.height?w._options.height:2e3;this._handler.setInputAction(function(e){var a=w._globe.getLonLatByPosition(e.endPosition);if(w._options.draw){for(var r=0;r<w._layer.length;r++){if(w._layer[r].polygon.id==w._options.drawid){var t=w._layer[r].pointList;t[1]=a;var o=new Array;var i=new Array;o.push(t[0].lon);o.push(t[0].lat);o.push(t[0].alt);i.push(t[0].lon);i.push(t[0].lat);i.push(n);o.push(t[0].lon);o.push(t[1].lat);o.push(t[0].alt);i.push(t[1].lon);i.push(t[0].lat);i.push(n);o.push(t[1].lon);o.push(t[1].lat);o.push(t[1].alt);i.push(t[1].lon);i.push(t[1].lat);i.push(n);o.push(t[1].lon);o.push(t[0].lat);o.push(t[1].alt);i.push(t[0].lon);i.push(t[1].lat);i.push(n);i.push(t[0].lon);i.push(t[0].lat);i.push(n);w._layer[r].pointsArray=i;w._layer[r].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(o);w._layer[r].vertexLineList=Cesium.Cartesian3.fromDegreesArrayHeights(i)}}}else if(w._isdrag){}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this._handler.setInputAction(function(e){var a=w._viewer.scene.pick(e.position);if(Cesium.defined(a)){if(a.id){if(a.id.drag){w._isdrag=true;w._scene.screenSpaceCameraController.enableRotate=false;w._scene.screenSpaceCameraController.enableTranslate=false;w._scene.screenSpaceCameraController.enableZoom=false;w._scene.screenSpaceCameraController.enableTilt=false;w._scene.screenSpaceCameraController.enableLook=false;document.getElementById(w._globeId).style.cursor="pointer";for(var r=0;r<w._dragList.length;r++){if(w._dragList[r].obj==a.id){w._dragObjNun=r}}}}}},Cesium.ScreenSpaceEventType.LEFT_DOWN);this._handler.setInputAction(function(e){if(w._isdrag){w._isdrag=false;w._scene.screenSpaceCameraController.enableRotate=true;w._scene.screenSpaceCameraController.enableTranslate=true;w._scene.screenSpaceCameraController.enableZoom=true;w._scene.screenSpaceCameraController.enableTilt=true;w._scene.screenSpaceCameraController.enableLook=true;document.getElementById(w._globeId).style.cursor="default";w._dragObjNun=0}},Cesium.ScreenSpaceEventType.LEFT_UP)}e.prototype.editByHandler=function(e){var a=this;a._clearDrag();for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r]==e){a._dragNun=r;break}}var t=a._layer[a._dragNun].pointList;for(var r=0;r<t.length;r++){a._addDrag(t[r])}};e.prototype.editByHandlerEnd=function(){var e=this;e._clearDrag()};e.prototype._clearDrag=function(){var e=this;for(var a=e._dragList.length-1;a>=0;a--){e._viewer.entities.remove(e._dragList[a].obj);e._dragList.splice(a,1)}e._dragList=[]};e.prototype._addDrag=function(e){var a=this;var r={obj:null,position:null};r.position=Cesium.Cartesian3.fromDegrees(e.lon,e.lat);r.obj=a._viewer.entities.add({drag:true,position:new Cesium.CallbackProperty(function(){return r.position},false),ellipse:{semiMinorAxis:150,semiMajorAxis:150,material:Cesium.Color.RED.withAlpha(1)}});a._dragList[a._dragList.length]=r};e.prototype.drawHandler=function(e){var a=this;a._options.draw=true;a._options.drawid="";a._options.options=e;handlerCallback=e.handlerCallback?e.handlerCallback:null;a._options.handlerCallback=handlerCallback;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.deactivateHandler=function(){var e=this;e._options.draw=false;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].polygon==e){var t=a._layer[r].catalog;var o=a._layer[r].subcatalog;var i=a._viewer.entities.remove(a._layer[r].polygon);i=a._viewer.entities.remove(a._layer[r].polyline);a._layer.splice(r,1);return i}}};e.prototype.removeByMid=function(e){var a=this;var r=true;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.mid==e){var o=a._layer[t].catalog;var i=a._layer[t].subcatalog;r=a._viewer.entities.remove(a._layer[t].polygon);r=a._viewer.entities.remove(a._layer[t].polyline);a._layer.splice(t,1);if(!r){console.log("false!!!!");return r}}}return r};e.prototype.removeByName=function(e){var a=this;var r=true;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.name==e){var o=a._layer[t].catalog;var i=a._layer[t].subcatalog;r=a._viewer.entities.remove(a._layer[t].polygon);r=a._viewer.entities.remove(a._layer[t].polyline);a._layer.splice(t,1);if(!r){return r}}}return r};e.prototype.getByMid=function(e){var a=this;var r=[];for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.mid==e){r[r.length]=a._layer[t].polygon}}return r};e.prototype.getByName=function(e){var a=this;var r=[];for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polygon.name==e){r[r.length]=a._layer[t].polygon}}return r};return e});