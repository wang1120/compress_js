define([],function(){function t(t){var i=this;this._globe=t;this._viewer=t._viewer;this._globeId=t._globeId;this._pointToPoint=false;this._pointToPolygon=false;this._sPoint=null;this._ePoint=null;this._objList=[];this._polyline=null;this._vertexList=[];this._towerHeight=1;this._treeHeight=0;this._targetHeight=0;this._showMenu=true;this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(t){var e=i._globe.getLonLatByPosition(t.position);if(e){if(i._pointToPoint){if(i._polyline==null){i._vertexList=[];i._polyline=i._viewer.entities.add({polyline:{positions:new Cesium.CallbackProperty(function(){return i._vertexList},false),material:new Cesium.PolylineDashMaterialProperty({color:Cesium.Color.CYAN})}})}if(i._sPoint==null){i._globe.getAltByLonlat([{lon:e.lon,lat:e.lat}],function(t){i._sPoint=t[0];i._sPoint.alt=i._sPoint.alt+i._towerHeight;i._addMark(i._sPoint,"起")})}else{i._globe.getAltByLonlat([{lon:e.lon,lat:e.lat}],function(t){i._ePoint=t[0];i._ePoint.alt=i._ePoint.alt+i._targetHeight;i._addMark(i._ePoint,"止");i._actionCompute()})}}}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(t){var e=i._globe.getLonLatByPosition(t.position);if(e){if(i._pointToPoint){if(i._sPoint!=null){i._globe.getAltByLonlat([{lon:e.lon,lat:e.lat}],function(t){i._pointToPoint=false;i._ePoint=t[0];i._ePoint.alt=i._ePoint.alt+i._targetHeight;i._addMark(i._ePoint,"止");i._actionCompute();i._vertexList=[]})}i._globe.globeMenu.setType(i._showMenu)}}},Cesium.ScreenSpaceEventType.RIGHT_CLICK);this._handler.setInputAction(function(t){var e=i._globe.getLonLatByPosition(t.endPosition);if(e){if(i._pointToPoint){if(i._sPoint!=null){i._globe.getAltByLonlat([{lon:e.lon,lat:e.lat}],function(t){var e=new Array;e.push(i._sPoint.lon);e.push(i._sPoint.lat);e.push(i._sPoint.alt);e.push(t[0].lon);e.push(t[0].lat);e.push(t[0].alt+i._targetHeight);i._vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(e)})}}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}t.prototype.intervisibilityByPoints=function(t){self._towerHeight=t.towerHeight?t.towerHeight:1;self._treeHeight=t.treeHeight?t.treeHeight:0;self._targetHeight=t.targetHeight?t.targetHeight:0;self._sPoint=t.sPoint?t.sPoint:null;self._ePoint=t.ePoint?t.ePoint:null;if(self._sPoint&&self._ePoint){self._sPoint.alt=self._sPoint.alt+self._towerHeight;self._addMark(self._sPoint,"起");self._ePoint.alt=self._ePoint.alt+self._targetHeight;self._addMark(self._ePoint,"止");self._actionCompute()}else{alert("起止点信息不能为空！")}};t.prototype.actionIntervisibility=function(t){var e=this;e._towerHeight=t.towerHeight?t.towerHeight:1;e._treeHeight=t.treeHeight?t.treeHeight:0;e._targetHeight=t.targetHeight?t.targetHeight:0;e._pointToPoint=true;e._sPoint=null;e._ePoint=null;e._showMenu=e._globe.globeMenu._showMenu;e._globe.globeMenu.setType(false)};t.prototype.endIntervisibility=function(){var t=this;t._towerHeight=1;t._treeHeight=0;t._targetHeight=0;t._pointToPoint=false;t._sPoint=null;t._ePoint=null};t.prototype.clear=function(){var t=this;t.endIntervisibility();t._vertexList=[];for(var e=t._objList.length-1;e>=0;e--){t._viewer.entities.remove(t._objList[e]);t._objList.pop()}};t.prototype._addMark=function(t,e){var i=this;var a=new Cesium.PinBuilder;var o=i._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(t.lon,t.lat,t.alt),billboard:{image:a.fromText(e,Cesium.Color.RED,48).toDataURL(),width:30,height:30,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,disableDepthTestDistance:Number.POSITIVE_INFINITY}});i._objList[i._objList.length]=o};t.prototype._actionCompute=function(){var s=this;s.getIntersectionByPoints(s._sPoint,s._ePoint,function(t){if(t){s._addMark(t,"交");var e=new Array;e.push(s._sPoint.lon);e.push(s._sPoint.lat);e.push(s._sPoint.alt);e.push(t.lon);e.push(t.lat);e.push(t.alt);var i=Cesium.Cartesian3.fromDegreesArrayHeights(e);var a=s._viewer.entities.add({polyline:{positions:i,material:Cesium.Color.GREEN}});s._objList[s._objList.length]=a;var o=new Array;o.push(t.lon);o.push(t.lat);o.push(t.alt);o.push(s._ePoint.lon);o.push(s._ePoint.lat);o.push(s._ePoint.alt);var n=Cesium.Cartesian3.fromDegreesArrayHeights(o);var r=s._viewer.entities.add({polyline:{positions:n,material:Cesium.Color.RED}});s._objList[s._objList.length]=r}else{var o=new Array;o.push(s._sPoint.lon);o.push(s._sPoint.lat);o.push(s._sPoint.alt);o.push(s._ePoint.lon);o.push(s._ePoint.lat);o.push(s._ePoint.alt);var n=Cesium.Cartesian3.fromDegreesArrayHeights(o);var r=s._viewer.entities.add({polyline:{positions:n,material:Cesium.Color.GREEN}});s._objList[s._objList.length]=r}if(!s._pointToPoint){s._sPoint=null;s._ePoint=null}})};t.prototype.getIntersectionByPoints=function(t,e,i){var a=this;var o=t.lon;var n=t.lat;var r=t.alt;var s=e.lon;var l=e.lat;var _=e.alt;var h=CommonFunc.getDistance(o,n,s,l);a._getIntersectionByRay(h,o,n,r,s,l,_,i)};t.prototype.getIntersectionByAngle=function(t){var e=this;var i=t.lon?parseFloat(t.lon):0;var a=t.lat?parseFloat(t.lat):0;var o=t.alt?parseFloat(t.alt):0;var n=t.horizontal?parseFloat(t.horizontal):0;var r=t.pitch?parseFloat(t.pitch):0;var s=t.dist?parseInt(t.dist):15e3;var l=t.callback?t.callback:null;var _=CommonFunc.destinationVincenty(i,a,o,n,r,5e3);var h=_.lon;var u=_.lat;var g=_.alt;e._getIntersectionByRay(s,i,a,o,h,u,g,l)};t.prototype._getIntersectionByRay=function(c,t,e,a,o,n,r,C){var P=this;var s=Cesium.Cartesian3.fromDegrees(t,e,a);var l=Cesium.Cartesian3.fromDegrees(o,n,r);var _=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(l,s,_);Cesium.Cartesian3.normalize(_,_);var m=new Cesium.Ray(s,_);var y=[];var h=[];for(i=0;i<1e3;i++){var u=i*100;var g=Cesium.Ray.getPoint(m,u);if(u>c){g=Cesium.Ray.getPoint(m,c)}var p=Cesium.Cartographic.fromCartesian(g);var v=Cesium.Math.toDegrees(p.longitude);var f=Cesium.Math.toDegrees(p.latitude);var d=p.height;var b=new Cesium.Cartographic(p.longitude,p.latitude);h.push(b);y.push({lon:v,lat:f,alt:d});if(u>c){break}}var w=Cesium.sampleTerrain(P._viewer.terrainProvider,P._globe._stkLevel,h);Cesium.when(w,function(t){var o=null;try{var e=P._viewer.scene.globe.ellipsoid.cartographicArrayToCartesianArray(t);var i=true;for(var a=0;a<y.length;a++){var n=Cesium.Cartographic.fromCartesian(e[a]);if(y[a].alt<n.height+P._treeHeight){if(a>0){i=false;var r=[];var s=[];for(k=0;k<21;k++){var l=k*5;var _=Cesium.Ray.getPoint(m,l+(a-1)*100);if(l>c){_=Cesium.Ray.getPoint(m,c)}var h=Cesium.Cartographic.fromCartesian(_);var u=Cesium.Math.toDegrees(h.longitude);var g=Cesium.Math.toDegrees(h.latitude);var p=h.height;var v=new Cesium.Cartographic(h.longitude,h.latitude);s.push(v);r.push({lon:u,lat:g,alt:p});if(l>c){break}}var f=Cesium.sampleTerrain(P._viewer.terrainProvider,P._globe._stkLevel,s);Cesium.when(f,function(t){var e=P._viewer.scene.globe.ellipsoid.cartographicArrayToCartesianArray(t);for(var i=0;i<r.length;i++){var a=Cesium.Cartographic.fromCartesian(e[i]);if(r[i].alt<a.height+P._treeHeight){o=r[i-1];break}}if(C){C(o)}})}break}}if(i){if(C){C(o)}}}catch(t){if(C){C(o)}}})};t.prototype.getDestinationVincentyByAngle=function(t){var e=this;var i=t.lon?parseFloat(t.lon):0;var a=t.lat?parseFloat(t.lat):0;var o=t.alt?parseFloat(t.alt):0;var n=t.horizontal?parseFloat(t.horizontal):0;var r=t.pitch?parseFloat(t.pitch):0;var s=t.dist?parseInt(t.dist):5e3;var l=CommonFunc.destinationVincenty(i,a,o,n,r,s);return l};return t});