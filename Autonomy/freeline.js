define([],function(){function e(e){var f=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._layer=[];this._showMenu=true;this._stkLevel=14;this._options={draw:false,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",drawid:"",handlerCallback:null,options:null};this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=f._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var t=Cesium.Cartographic.fromCartesian(f._viewer.scene.camera.position);e=t.height}else{e=Math.ceil(f._viewer.camera.positionCartographic.height)}for(var r=0;r<f._layer.length;r++){if(e>=f._layer[r].minHeight&&e<=f._layer[r].maxHeight){f._layer[r].showHeight=true}else{f._layer[r].showHeight=false}if(f._layer[r].showHeight&&f._layer[r].showLayer&&f._layer[r].showEntity){f._layer[r].freeline.show=true}else{f._layer[r].freeline.show=false}}});this._handler.setInputAction(function(e){var a=f._globe.getLonLatByPosition(e.position);if(f._options.draw&&f._options.drawid==""){var t={};for(var r in f._options.options){if(r!="color"&&r!="layer"){t[r]=typeof f._options.options[r]==="object"?deepCoyp(f._options.options[r]):f._options.options[r]}}var i=t.mid?t.mid:"";var o=t.name?t.name:"";var n=t.width?t.width:3;var l=t.wlpha?t.wlpha:.5;var s=t.rightClick?t.rightClick:null;var h=t.catalog?t.catalog:f._catalog;var v=t.subcatalog?t.subcatalog:f._subcatalog;var u=t.minHeight?t.minHeight:f._minHeight;var g=t.maxHeight?t.maxHeight:f._maxHeight;var _=f._options.options.color?f._options.options.color:Cesium.Color.BLUE;var p=f._options.options.layer?f._options.options.layer:f._globe._defaultLayer;var y=f._options.options.clampMode?f._options.options.clampMode:0;var m=[a];var d={freeline:null,pointList:m,vertexList:null,catalog:h,subcatalog:v,minHeight:u,maxHeight:g,showHeight:true,showLayer:true,showEntity:true,layer:p};d.freeline=f._viewer.entities.add({mid:i,name:o,options:t,rightClick:s,polyline:{positions:new Cesium.CallbackProperty(function(){return d.vertexList},false),width:n,material:_.withAlpha(l)}});f._layer.push(d);f._options.drawid=d.freeline.id;var c=(new Date).getTime()+"a"+parseInt(100*Math.random());f._globe.layerManager._add("entityLayer",c,h,v)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=f._globe.getLonLatByPosition(e.endPosition);if(f._options.draw&&f._options.drawid!=""){f._layer[f._layer.length-1].pointList.push(a);var t=f._layer[f._layer.length-1].pointList.slice(0);var r=new Array;for(var i=0;i<t.length;i++){r.push(t[i].lon);r.push(t[i].lat);r.push(t[i].alt+5)}f._layer[f._layer.length-1].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(r)}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this._handler.setInputAction(function(e){var a=f._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}if(f._options.draw&&f._options.drawid!=""){var t=f._layer[f._layer.length-1].pointList.slice(0);var r=f._layer[f._layer.length-1].freeline.options;var i=r.clampMode?r.clampMode:0;if(i==1){var o=50;var n=[];for(var l=1;l<t.length;l++){var s=Cesium.Math.toRadians(t[l-1].lon);var h=Cesium.Math.toRadians(t[l-1].lat);var v=Cesium.Math.toRadians(t[l].lon);var u=Cesium.Math.toRadians(t[l].lat);for(var g=0;g<o;g++){var _=Cesium.Math.lerp(s,v,g/(o-1));var p=Cesium.Math.lerp(h,u,g/(o-1));var y=new Cesium.Cartographic(_,p);if(!f._contains(n,y)){n.push(y)}}}var m=Cesium.sampleTerrain(f._viewer.terrainProvider,f._globe._stkLevel,n);Cesium.when(m,function(e){for(var a=0;a<e.length;a++){e[a].lon=CommonFunc.deg(e[a].longitude);e[a].lat=CommonFunc.deg(e[a].latitude);if(typeof e[a].height!=="undefined"){e[a].alt=e[a].height}else{e[a].alt=1e3}}var t=new Array;for(var r=0;r<e.length;r++){t.push(e[r].lon);t.push(e[r].lat);t.push(e[r].alt+5)}f._layer[f._layer.length-1].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(t)})}else{var d=new Array;for(var c=0;c<t.length;c++){d.push(t[c].lon);d.push(t[c].lat);d.push(t[c].alt+200)}f._layer[f._layer.length-1].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(d)}f._options.drawid="";if(f._options.handlerCallback)f._options.handlerCallback(f._layer[f._layer.length-1])}},Cesium.ScreenSpaceEventType.RIGHT_CLICK)}e.prototype.drawHandler=function(e){var a=this;a._options.draw=true;a._options.drawid="";a._options.options=e;var t=e.handlerCallback?e.handlerCallback:null;a._options.handlerCallback=t;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.add=function(e){var a=this;var t=e.mid?e.mid:"";var r=e.name?e.name:"";var i=e.width?parseInt(e.width):3;var o=e.wlpha?parseFloat(e.wlpha):1;var n=e.rightClick?e.rightClick:null;var l=e.color?e.color:Cesium.Color.BLUE;var s=e.pointList?e.pointList:[];var h=e.layer?e.layer:a._globe._defaultLayer;var v=e.catalog?e.catalog:a._catalog;var u=e.subcatalog?e.subcatalog:a._subcatalog;var g=e.minHeight?e.minHeight:a._minHeight;var _=e.maxHeight?e.maxHeight:a._maxHeight;var p={freeline:null,pointList:s,vertexList:null,catalog:v,subcatalog:u,minHeight:g,maxHeight:_,showHeight:true,showLayer:true,showEntity:true,layer:h};var y=s.slice(0);var m=e.clampMode?e.clampMode:0;if(m==1){var d=50;var c=[];for(var f=1;f<y.length;f++){var w=Cesium.Math.toRadians(y[f-1].lon);var C=Cesium.Math.toRadians(y[f-1].lat);var b=Cesium.Math.toRadians(y[f].lon);var L=Cesium.Math.toRadians(y[f].lat);for(var M=0;M<d;M++){var H=Cesium.Math.lerp(w,b,M/(d-1));var x=Cesium.Math.lerp(C,L,M/(d-1));var k=new Cesium.Cartographic(H,x);if(!a._contains(c,k)){c.push(k)}}}var A=Cesium.sampleTerrain(a._viewer.terrainProvider,a._globe._stkLevel,c);Cesium.when(A,function(e){for(var a=0;a<e.length;a++){e[a].lon=CommonFunc.deg(e[a].longitude);e[a].lat=CommonFunc.deg(e[a].latitude);if(typeof e[a].height!=="undefined"){e[a].alt=e[a].height}else{e[a].alt=1e3}}var t=new Array;for(var r=0;r<e.length;r++){t.push(e[r].lon);t.push(e[r].lat);t.push(e[r].alt+10)}p.vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(t)})}else{var E=new Array;for(var I=0;I<y.length;I++){E.push(y[I].lon);E.push(y[I].lat);E.push(y[I].alt+200)}p.vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(E)}p.freeline=a._viewer.entities.add({mid:t,name:r,options:e,rightClick:n,polyline:{positions:new Cesium.CallbackProperty(function(){return p.vertexList},false),width:i,material:l.withAlpha(o)}});a._layer.push(p);var S=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",S,v,u);return p};e.prototype.deactivateHandler=function(){var e=this;e._options.draw=false;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].freeline==e){var r=a._layer[t].catalog;var i=a._layer[t].subcatalog;var o=a._viewer.entities.remove(e);a._globe.layerManager._remove("entityLayer",r,i);a._layer.splice(t,1);return o}}};e.prototype.removeByMid=function(e){var a=this;var t=true;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].freeline.mid==e){var i=a._layer[r].catalog;var o=a._layer[r].subcatalog;t=a._viewer.entities.remove(a._layer[r].freeline);a._globe.layerManager._remove("entityLayer",i,o);a._layer.splice(r,1);if(!t){return t}}}return t};e.prototype.removeByName=function(e){var a=this;var t=true;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].freeline.name==e){var i=a._layer[r].catalog;var o=a._layer[r].subcatalog;t=a._viewer.entities.remove(a._layer[r].freeline);a._globe.layerManager._remove("entityLayer",i,o);a._layer.splice(r,1);if(!t){return t}}}return t};e.prototype.getByMid=function(e){var a=this;var t=[];for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].freeline.mid==e){t[t.length]=a._layer[r].freeline}}return t};e.prototype.getByName=function(e){var a=this;var t=[];for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].freeline.name==e){t[t.length]=a._layer[r].freeline}}return t};e.prototype._contains=function(e,a){var t=e.length;while(t--){if(e[t].longitude===a.longitude&&e[t].latitude===a.latitude){return true}}return false};return e});