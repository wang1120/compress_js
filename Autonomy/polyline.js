define([],function(){function e(e){var L=this;this._globe=e;this._viewer=e._viewer;this._globeId=e._globeId;this._minHeight=0;this._maxHeight=1e6;this._catalog="default";this._subcatalog="default";this._layer=[];this._showMenu=true;this._options={draw:false,minHeight:0,maxHeight:1e6,catalog:"default",subcatalog:"default",handlerCallback:null,options:null,drawid:""};this._viewer.scene.postRender.addEventListener(function(){var e=0;var a=L._viewer.scene.mode;if(a==Cesium.SceneMode.SCENE3D){var t=Cesium.Cartographic.fromCartesian(L._viewer.scene.camera.position);e=t.height}else{e=Math.ceil(L._viewer.camera.positionCartographic.height)}for(var r=0;r<L._layer.length;r++){if(e>=L._layer[r].minHeight&&e<=L._layer[r].maxHeight){L._layer[r].showHeight=true}else{L._layer[r].showHeight=false}if(L._layer[r].showHeight&&L._layer[r].showLayer&&L._layer[r].showEntity){L._layer[r].show=true}else{L._layer[r].show=false}}});this._handler=new Cesium.ScreenSpaceEventHandler(this._viewer.scene.canvas);this._handler.setInputAction(function(e){var a=L._globe.getLonLatByPosition(e.position);if(L._options.draw){var t={};for(var r in L._options.options){if(r!="color"&&r!="layer"){t[r]=typeof L._options.options[r]==="object"?deepCoyp(L._options.options[r]):L._options.options[r]}}if(L._options.drawid==""){var i=t.mid?t.mid:"";var l=t.name?t.name:"default";var o=t.width?t.width:3;var n=t.wlpha?t.wlpha:1;var s=t.rightClick?t.rightClick:null;var h=L._options.options.color?L._options.options.color:Cesium.Color.BLUE;var p=L._options.options.layer?L._options.options.layer:L._globe._defaultLayer;var _=t.catalog?t.catalog:L._catalog;var v=t.subcatalog?t.subcatalog:L._subcatalog;var y=t.minHeight?t.minHeight:L._minHeight;var g=t.maxHeight?t.maxHeight:L._maxHeight;var u=t.clampMode?t.clampMode:0;var d=[a];var m={mid:i,name:l,polyline:null,pointList:d,vertexList:null,catalog:_,subcatalog:v,minHeight:y,maxHeight:g,showHeight:true,showLayer:true,showEntity:true,layer:p,clampMode:u};m.polyline=L._viewer.entities.add({mid:i,name:l,options:t,rightClick:s,polyline:{positions:new Cesium.CallbackProperty(function(){return m.vertexList},false),width:o,material:h.withAlpha(n)}});L._layer[L._layer.length]=m;L._options.drawid=m.polyline.id;var c=(new Date).getTime()+"a"+parseInt(100*Math.random());L._globe.layerManager._add("entityLayer",c,_,v)}else{for(var f=0;f<L._layer.length;f++){if(L._layer[f].polyline.id==L._options.drawid){L._layer[f].pointList[L._layer[f].pointList.length]=a;var w=new Array;for(var C=0;C<L._layer[f].pointList.length;C++){w.push(L._layer[f].pointList[C].lon);w.push(L._layer[f].pointList[C].lat);w.push(L._layer[f].pointList[C].alt+200)}L._layer[f].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(w)}}}}},Cesium.ScreenSpaceEventType.LEFT_CLICK);this._handler.setInputAction(function(e){var a=L._globe.getLonLatByPosition(e.position);if(a.alt<0){a.alt=0}if(L._options.draw){if(L._options.handlerCallback){for(var i=0;i<L._layer.length;i++){if(L._layer[i].polyline.id==L._options.drawid){L._layer[i].pointList[L._layer[i].pointList.length]=a;if(L._layer[i].clampMode==1){var t=500;var r=[];for(var l=1;l<L._layer[i].pointList.length;l++){var o=Cesium.Math.toRadians(L._layer[i].pointList[l-1].lon);var n=Cesium.Math.toRadians(L._layer[i].pointList[l-1].lat);var s=Cesium.Math.toRadians(L._layer[i].pointList[l].lon);var h=Cesium.Math.toRadians(L._layer[i].pointList[l].lat);for(var p=0;p<t;p++){var _=Cesium.Math.lerp(o,s,p/(t-1));var v=Cesium.Math.lerp(n,h,p/(t-1));var y=new Cesium.Cartographic(_,v);r.push(y)}}var g=Cesium.sampleTerrain(L._viewer.terrainProvider,L._globe._stkLevel,r);Cesium.when(g,function(e){for(var a=0;a<e.length;a++){e[a].lon=CommonFunc.deg(e[a].longitude);e[a].lat=CommonFunc.deg(e[a].latitude);if(typeof e[a].height!=="undefined"){e[a].alt=e[a].height}else{e[a].alt=1e3}}var t=new Array;for(var r=0;r<e.length;r++){t.push(e[r].lon);t.push(e[r].lat);t.push(e[r].alt+10)}L._layer[i].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(t)});L._options.drawid="";L._options.handlerCallback(L._layer[i]);break}else{L._options.drawid="";L._options.handlerCallback(L._layer[i]);break}}}}else{L._options.drawid=""}}},Cesium.ScreenSpaceEventType.RIGHT_CLICK);this._handler.setInputAction(function(e){var a=L._globe.getLonLatByPosition(e.endPosition);if(L._options.draw){for(var t=0;t<L._layer.length;t++){if(L._layer[t].polyline.id==L._options.drawid){var r=L._layer[t].pointList.slice(0);r[r.length]=a;var i=new Array;for(var l=0;l<r.length;l++){i.push(r[l].lon);i.push(r[l].lat);i.push(r[l].alt+200)}L._layer[t].vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(i)}}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}e.prototype.add=function(e){var a=this;var t=e.mid?e.mid:"";var r=e.name?e.name:"default";var i=e.width?parseInt(e.width):3;var l=e.wlpha?parseFloat(e.wlpha):1;var o=e.leftClick?e.leftClick:null;var n=e.rightClick?e.rightClick:null;var s=e.color?e.color:Cesium.Color.BLUE;var h=e.pointList?e.pointList:[];var p=e.layer?e.layer:a._globe._defaultLayer;var _=e.catalog?e.catalog:a._catalog;var v=e.subcatalog?e.subcatalog:a._subcatalog;var y=e.minHeight?e.minHeight:a._minHeight;var g=e.maxHeight?e.maxHeight:a._maxHeight;var u=e.clampMode?e.clampMode:0;var d=e.up?e.up:.5;var m=[];var c=new Array;var f={mid:t,name:r,polyline:null,pointList:h,vertexList:m,layer:p,catalog:_,subcatalog:v,minHeight:y,maxHeight:g,showHeight:true,showLayer:true,showEntity:true,clampMode:u};if(u==1){var w=50;var C=[];for(var L=1;L<h.length;L++){var b=Cesium.Math.toRadians(h[L-1].lon);var M=Cesium.Math.toRadians(h[L-1].lat);var H=Cesium.Math.toRadians(h[L].lon);var k=Cesium.Math.toRadians(h[L].lat);for(var x=0;x<w;x++){var E=Cesium.Math.lerp(b,H,x/(w-1));var A=Cesium.Math.lerp(M,k,x/(w-1));var I=new Cesium.Cartographic(E,A);C.push(I)}}var S=Cesium.sampleTerrain(a._viewer.terrainProvider,a._globe._stkLevel,C);Cesium.when(S,function(e){for(var a=0;a<e.length;a++){e[a].lon=CommonFunc.deg(e[a].longitude);e[a].lat=CommonFunc.deg(e[a].latitude);if(typeof e[a].height!=="undefined"){e[a].alt=e[a].height}else{e[a].alt=0}}for(var t=0;t<e.length;t++){c.push(e[t].lon);c.push(e[t].lat);c.push(e[t].alt+d)}f.vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(c)})}else{for(var T=0;T<h.length;T++){c.push(h[T].lon);c.push(h[T].lat);c.push(h[T].alt)}f.vertexList=Cesium.Cartesian3.fromDegreesArrayHeights(c)}f.polyline=a._viewer.entities.add({mid:t,name:r,options:e,leftClick:o,rightClick:n,polyline:{positions:new Cesium.CallbackProperty(function(){return f.vertexList},false),width:i,material:s.withAlpha(l)}});a._layer[a._layer.length]=f;var R=(new Date).getTime()+"a"+parseInt(100*Math.random());a._globe.layerManager._add("entityLayer",R,_,v);return f};e.prototype.drawHandler=function(e){var a=this;a._options.draw=true;a._options.drawid="";a._options.options=e;var t=e.handlerCallback?e.handlerCallback:null;a._options.handlerCallback=t;a._showMenu=a._globe.globeMenu._showMenu;a._globe.globeMenu.setType(false)};e.prototype.deactivateHandler=function(){var e=this;e._options.draw=false;e._globe.globeMenu.setType(e._showMenu)};e.prototype.remove=function(e){var a=this;for(var t=a._layer.length-1;t>=0;t--){if(a._layer[t].polyline==e.polyline){var r=a._layer[t].catalog;var i=a._layer[t].subcatalog;var l=a._viewer.entities.remove(e.polyline);a._globe.layerManager._remove("entityLayer",r,i);a._layer.splice(t,1);return l}}};e.prototype.removeByMid=function(e){var a=this;var t=true;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].polyline.mid==e){var i=a._layer[r].catalog;var l=a._layer[r].subcatalog;t=a._viewer.entities.remove(a._layer[r].polyline);a._globe.layerManager._remove("entityLayer",i,l);a._layer.splice(r,1);if(!t){return t}}}return t};e.prototype.removeByName=function(e){var a=this;var t=true;for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].polyline.name==e){var i=a._layer[r].catalog;var l=a._layer[r].subcatalog;t=a._viewer.entities.remove(a._layer[r].polyline);a._globe.layerManager._remove("entityLayer",i,l);a._layer.splice(r,1);if(!t){return t}}}return t};e.prototype.getByMid=function(e){var a=this;var t=[];for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].polyline.mid==e){t[t.length]=a._layer[r].polyline}}return t};e.prototype.getByName=function(e){var a=this;var t=[];for(var r=a._layer.length-1;r>=0;r--){if(a._layer[r].polyline.name==e){t[t.length]=a._layer[r].polyline}}return t};return e});